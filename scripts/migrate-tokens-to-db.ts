#!/usr/bin/env tsx
/**
 * Script de migration des tokens API depuis .env vers la base de donn√©es (chiffr√©s)
 * IMPORTANT : Ex√©cuter UNE SEULE FOIS apr√®s avoir cr√©√© la table ApiToken
 */

import { migrateTokensFromEnv, checkExpiringTokens, listApiTokens } from '../src/lib/api-token-manager';

async function main() {
  console.log('\nüîê MIGRATION DES TOKENS API VERS LA BASE DE DONN√âES');
  console.log('‚ïê'.repeat(80) + '\n');

  console.log('‚ö†Ô∏è  IMPORTANT : Ce script va :');
  console.log('   1. Lire les tokens depuis .env.local');
  console.log('   2. Les chiffrer avec ENCRYPTION_KEY');
  console.log('   3. Les stocker dans la table ApiToken');
  console.log('   4. V√©rifier les dates d\'expiration\n');

  console.log('üìã Pr√©requis :');
  console.log('   - Table ApiToken cr√©√©e (npx prisma migrate dev)');
  console.log('   - ENCRYPTION_KEY configur√© dans .env.local');
  console.log('   - Tokens pr√©sents dans .env.local\n');

  console.log('‚ïê'.repeat(80) + '\n');

  try {
    // Migration
    await migrateTokensFromEnv();

    // Liste des tokens migr√©s
    console.log('‚ïê'.repeat(80));
    console.log('üìä TOKENS STOCK√âS EN BASE DE DONN√âES\n');

    const tokens = await listApiTokens();

    if (tokens.length === 0) {
      console.log('‚ö†Ô∏è  Aucun token trouv√© en base de donn√©es\n');
    } else {
      tokens.forEach((token, i) => {
        console.log(`${i + 1}. ${token.service}:${token.name}`);
        console.log(`   ID: ${token.id}`);
        console.log(`   Organisation: ${token.organizationId || 'Global (plateforme)'}`);
        console.log(`   Token chiffr√©: ${token.tokenEncrypted.substring(0, 40)}...`);

        if (token.expiresAt) {
          const now = new Date();
          const daysLeft = Math.ceil(
            (token.expiresAt.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)
          );

          if (daysLeft < 0) {
            console.log(`   ‚ö†Ô∏è  EXPIR√â depuis ${Math.abs(daysLeft)} jours`);
          } else if (daysLeft < 7) {
            console.log(`   ‚ö†Ô∏è  Expire dans ${daysLeft} jours`);
          } else {
            console.log(`   ‚úÖ Expire dans ${daysLeft} jours`);
          }
        } else {
          console.log(`   ‚úÖ Pas d'expiration`);
        }

        console.log(`   Cr√©√© le: ${token.createdAt.toLocaleDateString('fr-FR')}\n`);
      });
    }

    // V√©rification des expirations
    console.log('‚ïê'.repeat(80));
    console.log('‚è∞ V√âRIFICATION DES EXPIRATIONS\n');

    const expiring = await checkExpiringTokens(7);

    if (expiring.length === 0) {
      console.log('‚úÖ Aucun token n\'expire dans les 7 prochains jours\n');
    }

    // Recommandations
    console.log('‚ïê'.repeat(80));
    console.log('üìù PROCHAINES √âTAPES\n');

    console.log('1. ‚úÖ Tokens migr√©s en base de donn√©es (chiffr√©s)');
    console.log('2. üîÑ Modifier le code pour utiliser les tokens depuis la DB :');
    console.log('   - Utiliser getWhatsAppToken() au lieu de process.env.WHATSAPP_ACCESS_TOKEN');
    console.log('   - Utiliser getInstagramToken() au lieu de process.env.INSTAGRAM_ACCESS_TOKEN');
    console.log('   - Utiliser getFacebookToken() au lieu de process.env.FACEBOOK_PAGE_ACCESS_TOKEN');
    console.log('   - Utiliser getStripeKey() au lieu de process.env.STRIPE_SECRET_KEY');
    console.log('\n3. ‚ö†Ô∏è  OPTIONNEL : Supprimer les tokens de .env.local');
    console.log('   (Garder les en fallback pour le moment)');
    console.log('\n4. üîî Configurer les alertes d\'expiration (cron job)');
    console.log('   ‚Üí /api/cron/check-token-expiration\n');

    console.log('‚ïê'.repeat(80) + '\n');

    console.log('‚úÖ Migration termin√©e avec succ√®s !\n');

  } catch (error) {
    console.error('\n‚ùå Erreur durant la migration:\n');
    console.error(error);
    console.error('\nüí° V√©rifiez que :');
    console.error('   - La table ApiToken existe (npx prisma migrate dev)');
    console.error('   - ENCRYPTION_KEY est configur√© dans .env.local');
    console.error('   - Les tokens sont pr√©sents dans .env.local\n');
    process.exit(1);
  }
}

main().catch(console.error);
