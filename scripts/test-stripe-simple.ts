#!/usr/bin/env tsx
/**
 * Script simple de v√©rification de la configuration Stripe
 */

async function testStripe() {
  console.log('\nüí≥ V√âRIFICATION CONFIGURATION STRIPE\n');
  console.log('='.repeat(80) + '\n');

  // V√©rifier les variables d'environnement
  const secretKey = process.env.STRIPE_SECRET_KEY;
  const publishableKey = process.env.STRIPE_PUBLISHABLE_KEY;

  if (!secretKey) {
    console.log('‚ùå STRIPE_SECRET_KEY: MANQUANTE\n');
    return;
  }

  if (secretKey.startsWith('sk_test_')) {
    console.log('‚ö†Ô∏è  STRIPE_SECRET_KEY: MODE TEST');
    console.log('   ' + secretKey.substring(0, 20) + '...');
    console.log('   ‚Üí Passer en mode PRODUCTION (sk_live_)\n');
  } else if (secretKey.startsWith('sk_live_')) {
    console.log('‚úÖ STRIPE_SECRET_KEY: MODE PRODUCTION');
    console.log('   ' + secretKey.substring(0, 20) + '...\n');
  }

  if (!publishableKey) {
    console.log('‚ö†Ô∏è  STRIPE_PUBLISHABLE_KEY: MANQUANTE\n');
  } else if (publishableKey.startsWith('pk_test_')) {
    console.log('‚ö†Ô∏è  STRIPE_PUBLISHABLE_KEY: MODE TEST');
    console.log('   ' + publishableKey.substring(0, 20) + '...\n');
  } else if (publishableKey.startsWith('pk_live_')) {
    console.log('‚úÖ STRIPE_PUBLISHABLE_KEY: MODE PRODUCTION');
    console.log('   ' + publishableKey.substring(0, 20) + '...\n');
  }

  // Test de connexion
  console.log('='.repeat(80));
  console.log('üîå Test de connexion √† l\'API Stripe\n');

  try {
    const Stripe = (await import('stripe')).default;
    const stripe = new Stripe(secretKey, {
      apiVersion: '2024-11-20.acacia',
    });

    const account = await stripe.accounts.retrieve();

    console.log('‚úÖ Connexion r√©ussie !\n');
    console.log('üìä Informations du compte:\n');
    console.log('   Email: ' + (account.email || 'Non d√©fini'));
    console.log('   Pays: ' + account.country);
    console.log('   Type: ' + account.type);
    console.log('   Compte v√©rifi√©: ' + (account.charges_enabled ? 'Oui ‚úÖ' : 'Non ‚ùå'));
    console.log('   Paiements activ√©s: ' + (account.payouts_enabled ? 'Oui ‚úÖ' : 'Non ‚ùå'));
    console.log('');

    // V√©rifier webhooks
    const webhooks = await stripe.webhookEndpoints.list({ limit: 10 });

    console.log('='.repeat(80));
    console.log('üì° Webhooks: ' + webhooks.data.length + ' configur√©(s)\n');

    if (webhooks.data.length === 0) {
      console.log('‚ö†Ô∏è  Aucun webhook configur√©');
      console.log('   ‚Üí Aller sur Dashboard Stripe > Developers > Webhooks\n');
    } else {
      webhooks.data.forEach((wh, i) => {
        console.log((i + 1) + '. ' + wh.url);
        console.log('   Status: ' + wh.status);
        console.log('   √âv√©nements: ' + wh.enabled_events.length + '\n');
      });
    }

    // R√©sum√©
    console.log('='.repeat(80));
    console.log('üìù R√âSUM√â\n');

    const isProduction = secretKey.startsWith('sk_live_');
    const hasWebhooks = webhooks.data.length > 0;
    const isVerified = account.charges_enabled && account.payouts_enabled;

    if (isProduction && hasWebhooks && isVerified) {
      console.log('‚úÖ Configuration PR√äTE pour la PRODUCTION\n');
    } else {
      console.log('‚ö†Ô∏è  Configuration INCOMPL√àTE\n');

      if (!isProduction) {
        console.log('‚ùå Passer en mode PRODUCTION');
        console.log('   ‚Üí Utiliser sk_live_ et pk_live_\n');
      }

      if (!hasWebhooks) {
        console.log('‚ùå Configurer les webhooks');
        console.log('   ‚Üí Dashboard Stripe > Developers > Webhooks\n');
      }

      if (!isVerified) {
        console.log('‚ùå Finaliser la v√©rification du compte');
        console.log('   ‚Üí Compl√©ter KYC/KYB et coordonn√©es bancaires\n');
      }
    }

    console.log('='.repeat(80) + '\n');

  } catch (error: any) {
    console.error('\n‚ùå ERREUR de connexion √† Stripe:\n');
    console.error('   ' + error.message + '\n');
  }
}

testStripe().catch(console.error);
