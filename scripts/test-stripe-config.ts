#!/usr/bin/env tsx
/**
 * Script de v√©rification de la configuration Stripe
 */

import Stripe from 'stripe';

async function testStripeConfig() {
  console.log('\nüí≥ V√âRIFICATION CONFIGURATION STRIPE');
  console.log('‚ïê'.repeat(80) + '\n');

  // V√©rifier les variables d'environnement
  const secretKey = process.env.STRIPE_SECRET_KEY;
  const publishableKey = process.env.STRIPE_PUBLISHABLE_KEY;
  const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET;

  console.log('üìã Variables d\'environnement:\n');

  // Secret Key
  if (!secretKey) {
    console.log('‚ùå STRIPE_SECRET_KEY: MANQUANTE');
    console.log('   ‚Üí Ajouter dans .env.local\n');
    return;
  } else if (secretKey.startsWith('sk_test_')) {
    console.log('‚ö†Ô∏è  STRIPE_SECRET_KEY: MODE TEST');
    console.log(`   ${secretKey.substring(0, 20)}...`);
    console.log('   ‚Üí Passer en mode PRODUCTION (sk_live_) avant d√©ploiement\n');
  } else if (secretKey.startsWith('sk_live_')) {
    console.log('‚úÖ STRIPE_SECRET_KEY: MODE PRODUCTION');
    console.log(`   ${secretKey.substring(0, 20)}...\n`);
  } else {
    console.log('‚ùå STRIPE_SECRET_KEY: FORMAT INVALIDE');
    console.log(`   ${secretKey.substring(0, 20)}...\n`);
    return;
  }

  // Publishable Key
  if (!publishableKey) {
    console.log('‚ö†Ô∏è  STRIPE_PUBLISHABLE_KEY: MANQUANTE');
    console.log('   ‚Üí Ajouter dans .env.local\n');
  } else if (publishableKey.startsWith('pk_test_')) {
    console.log('‚ö†Ô∏è  STRIPE_PUBLISHABLE_KEY: MODE TEST');
    console.log(`   ${publishableKey.substring(0, 20)}...\n`);
  } else if (publishableKey.startsWith('pk_live_')) {
    console.log('‚úÖ STRIPE_PUBLISHABLE_KEY: MODE PRODUCTION');
    console.log(`   ${publishableKey.substring(0, 20)}...\n`);
  }

  // Webhook Secret
  if (!webhookSecret) {
    console.log('‚ö†Ô∏è  STRIPE_WEBHOOK_SECRET: MANQUANT');
    console.log('   ‚Üí Configurer dans Dashboard Stripe > Webhooks\n');
  } else {
    console.log('‚úÖ STRIPE_WEBHOOK_SECRET: CONFIGUR√â');
    console.log(`   ${webhookSecret.substring(0, 15)}...\n`);
  }

  // Test de connexion √† l'API Stripe
  console.log('‚ïê'.repeat(80));
  console.log('üîå Test de connexion √† l\'API Stripe\n');

  try {
    const stripe = new Stripe(secretKey, {
      apiVersion: '2024-11-20.acacia',
    });

    // R√©cup√©rer les informations du compte
    const account = await stripe.accounts.retrieve();

    console.log('‚úÖ Connexion r√©ussie !\n');
    console.log('üìä Informations du compte:\n');
    console.log(`   Email: ${account.email || 'Non d√©fini'}`);
    console.log(`   Pays: ${account.country}`);
    console.log(`   Devise par d√©faut: ${account.default_currency?.toUpperCase() || 'Non d√©finie'}`);
    console.log(`   Type: ${account.type}`);
    console.log(`   Compte v√©rifi√©: ${account.charges_enabled ? 'Oui ‚úÖ' : 'Non ‚ùå'}`);
    console.log(`   Paiements activ√©s: ${account.payouts_enabled ? 'Oui ‚úÖ' : 'Non ‚ùå'}\n');

    // V√©rifier les webhooks configur√©s
    console.log('‚ïê'.repeat(80));
    console.log('üì° Webhooks configur√©s\n');

    const webhooks = await stripe.webhookEndpoints.list({ limit: 10 });

    if (webhooks.data.length === 0) {
      console.log('‚ö†Ô∏è  Aucun webhook configur√©');
      console.log('   ‚Üí Configurer dans Dashboard Stripe > Developers > Webhooks\n');
    } else {
      webhooks.data.forEach((webhook, index) => {
        console.log(String(index + 1) + '. ' + webhook.url);
        console.log('   Status: ' + webhook.status);
        console.log('   √âv√©nements: ' + webhook.enabled_events.length);
        if (webhook.enabled_events.length > 0) {
          console.log('   - ' + webhook.enabled_events.slice(0, 3).join('\n   - '));
          if (webhook.enabled_events.length > 3) {
            console.log('   - ... et ' + (webhook.enabled_events.length - 3) + ' autres');
          }
        }
        console.log('');
      });
    }

    // R√©capitulatif
    console.log('‚ïê'.repeat(80));
    console.log('üìù R√âCAPITULATIF\n');

    const isProduction = secretKey.startsWith('sk_live_');
    const hasWebhooks = webhooks.data.length > 0;
    const isVerified = account.charges_enabled && account.payouts_enabled;

    if (isProduction && hasWebhooks && isVerified) {
      console.log('‚úÖ Configuration PR√äTE pour la PRODUCTION\n');
      console.log('Prochaines √©tapes:');
      console.log('1. Tester un paiement r√©el de faible montant');
      console.log('2. V√©rifier que le webhook est bien re√ßu');
      console.log('3. Tester un remboursement');
      console.log('4. Activer Radar anti-fraude');
      console.log('5. Configurer les notifications email\n');
    } else {
      console.log('‚ö†Ô∏è  Configuration INCOMPL√àTE\n');
      console.log('Actions requises:');

      if (!isProduction) {
        console.log('‚ùå Passer en mode PRODUCTION');
        console.log('   ‚Üí Obtenir les cl√©s sk_live_ et pk_live_');
        console.log('   ‚Üí Mettre √† jour .env.local et Vercel\n');
      }

      if (!hasWebhooks) {
        console.log('‚ùå Configurer les webhooks');
        console.log('   ‚Üí Dashboard Stripe > Developers > Webhooks');
        console.log('   ‚Üí Endpoint: https://votre-domaine.com/api/webhooks/stripe\n');
      }

      if (!isVerified) {
        console.log('‚ùå Finaliser la v√©rification du compte Stripe');
        console.log('   ‚Üí Compl√©ter les informations KYC/KYB');
        console.log('   ‚Üí Ajouter coordonn√©es bancaires\n');
      }
    }

  } catch (error: any) {
    console.error('\n‚ùå ERREUR lors de la connexion √† Stripe:\n');
    console.error(`   ${error.message}\n`);

    if (error.type === 'StripeAuthenticationError') {
      console.error('üí° V√©rifiez que votre STRIPE_SECRET_KEY est correcte');
    } else if (error.type === 'StripeAPIError') {
      console.error('üí° Probl√®me avec l\'API Stripe');
      console.error('   V√©rifiez https://status.stripe.com');
    }

    console.error('\n');
  }
}

testStripeConfig().catch(console.error);
