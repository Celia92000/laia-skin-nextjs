#!/usr/bin/env tsx
/**
 * Script de v√©rification de s√©curit√©
 * V√©rifie que toutes les mesures de s√©curit√© sont en place
 */

import { PrismaClient } from '@prisma/client';
import fs from 'fs';
import path from 'path';

const prisma = new PrismaClient();

interface SecurityIssue {
  severity: 'critical' | 'high' | 'medium' | 'low';
  category: string;
  issue: string;
  fix: string;
}

const issues: SecurityIssue[] = [];

async function checkSecurityConfig() {
  console.log('üîç V√©rification de la configuration de s√©curit√©...\n');

  // 1. V√©rifier JWT_SECRET
  console.log('üìå V√©rification JWT_SECRET...');
  const jwtSecret = process.env.JWT_SECRET;

  if (!jwtSecret) {
    issues.push({
      severity: 'critical',
      category: 'Authentication',
      issue: 'JWT_SECRET manquant',
      fix: 'G√©n√©rer un secret : openssl rand -base64 64'
    });
  } else if (jwtSecret.length < 32) {
    issues.push({
      severity: 'high',
      category: 'Authentication',
      issue: 'JWT_SECRET trop court (< 32 caract√®res)',
      fix: 'G√©n√©rer un secret plus long : openssl rand -base64 64'
    });
  } else if (jwtSecret === 'laia-skin-secret-key-2024') {
    issues.push({
      severity: 'critical',
      category: 'Authentication',
      issue: 'JWT_SECRET utilise encore la valeur par d√©faut',
      fix: 'Changer imm√©diatement : openssl rand -base64 64'
    });
  } else {
    console.log('  ‚úÖ JWT_SECRET configur√© correctement');
  }

  // 2. V√©rifier Stripe
  console.log('\nüìå V√©rification Stripe...');
  const stripeKey = process.env.STRIPE_SECRET_KEY;

  if (stripeKey?.startsWith('sk_test_')) {
    issues.push({
      severity: 'critical',
      category: 'Payments',
      issue: 'Stripe en mode TEST (sk_test_)',
      fix: 'Remplacer par les cl√©s de production (sk_live_) avant d√©ploiement'
    });
  } else if (stripeKey?.startsWith('sk_live_')) {
    console.log('  ‚úÖ Stripe en mode PRODUCTION');
  } else {
    issues.push({
      severity: 'high',
      category: 'Payments',
      issue: 'Cl√© Stripe manquante ou invalide',
      fix: 'Configurer STRIPE_SECRET_KEY dans .env.local'
    });
  }

  // 3. V√©rifier tokens Meta
  console.log('\nüìå V√©rification tokens Meta (WhatsApp, Instagram, Facebook)...');

  const whatsappToken = process.env.WHATSAPP_ACCESS_TOKEN;
  const instagramToken = process.env.INSTAGRAM_ACCESS_TOKEN;
  const facebookToken = process.env.FACEBOOK_PAGE_ACCESS_TOKEN;

  if (!whatsappToken || whatsappToken.length < 50) {
    issues.push({
      severity: 'high',
      category: 'Integrations',
      issue: 'Token WhatsApp manquant ou invalide',
      fix: 'Renouveler le token sur developers.facebook.com'
    });
  } else {
    console.log('  ‚úÖ Token WhatsApp pr√©sent');
  }

  if (!instagramToken || instagramToken.length < 50) {
    issues.push({
      severity: 'medium',
      category: 'Integrations',
      issue: 'Token Instagram manquant ou invalide',
      fix: 'Renouveler le token sur developers.facebook.com'
    });
  } else {
    console.log('  ‚úÖ Token Instagram pr√©sent');
  }

  if (!facebookToken || facebookToken.length < 50) {
    issues.push({
      severity: 'medium',
      category: 'Integrations',
      issue: 'Token Facebook manquant ou invalide',
      fix: 'Renouveler le token sur developers.facebook.com'
    });
  } else {
    console.log('  ‚úÖ Token Facebook pr√©sent');
  }

  // 4. V√©rifier Email
  console.log('\nüìå V√©rification Email (Resend)...');
  const resendKey = process.env.RESEND_API_KEY;

  if (!resendKey || resendKey.startsWith('re_')) {
    console.log('  ‚úÖ Resend API Key configur√©e');
  } else {
    issues.push({
      severity: 'high',
      category: 'Email',
      issue: 'Resend API Key manquante ou invalide',
      fix: 'Configurer RESEND_API_KEY dans .env.local'
    });
  }

  // 5. V√©rifier Sentry
  console.log('\nüìå V√©rification Sentry...');
  const sentryDsn = process.env.NEXT_PUBLIC_SENTRY_DSN;
  const sentryToken = process.env.SENTRY_AUTH_TOKEN;

  if (!sentryDsn) {
    issues.push({
      severity: 'medium',
      category: 'Monitoring',
      issue: 'Sentry DSN manquant',
      fix: 'Configurer NEXT_PUBLIC_SENTRY_DSN pour le monitoring d\'erreurs'
    });
  }

  if (!sentryToken) {
    issues.push({
      severity: 'low',
      category: 'Monitoring',
      issue: 'Sentry Auth Token manquant',
      fix: 'Configurer SENTRY_AUTH_TOKEN pour les source maps'
    });
  }

  // 6. V√©rifier fichiers sensibles
  console.log('\nüìå V√©rification fichiers sensibles...');
  const gitignorePath = path.join(process.cwd(), '.gitignore');

  if (fs.existsSync(gitignorePath)) {
    const gitignore = fs.readFileSync(gitignorePath, 'utf-8');

    if (!gitignore.includes('.env.local')) {
      issues.push({
        severity: 'critical',
        category: 'Security',
        issue: '.env.local n\'est pas dans .gitignore',
        fix: 'Ajouter .env.local au .gitignore imm√©diatement'
      });
    } else {
      console.log('  ‚úÖ .env.local dans .gitignore');
    }
  }
}

async function checkDatabaseSecurity() {
  console.log('\nüìå V√©rification s√©curit√© base de donn√©es...');

  try {
    // V√©rifier mots de passe par d√©faut
    const defaultPasswordUsers = await prisma.user.findMany({
      where: {
        OR: [
          { email: 'admin@laiaskin.com' },
          { email: 'superadmin@laiaskin.com' }
        ]
      },
      select: {
        id: true,
        email: true,
        role: true,
        updatedAt: true
      }
    });

    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

    for (const user of defaultPasswordUsers) {
      if (user.updatedAt < oneWeekAgo) {
        issues.push({
          severity: 'high',
          category: 'Authentication',
          issue: `Mot de passe de ${user.email} non chang√© r√©cemment`,
          fix: 'Ex√©cuter scripts/update-default-passwords.ts'
        });
      } else {
        console.log(`  ‚úÖ ${user.email} mis √† jour r√©cemment`);
      }
    }

    // V√©rifier super admin existe
    const superAdmin = await prisma.user.findFirst({
      where: { role: 'SUPER_ADMIN' }
    });

    if (!superAdmin) {
      issues.push({
        severity: 'critical',
        category: 'Access Control',
        issue: 'Aucun SUPER_ADMIN trouv√© en base',
        fix: 'Cr√©er un compte super admin avec un mot de passe fort'
      });
    } else {
      console.log('  ‚úÖ Super Admin existe');
    }

    // V√©rifier users sans email v√©rifi√© (quand le champ existera)
    // const unverifiedUsers = await prisma.user.count({
    //   where: { emailVerified: false }
    // });
    // console.log(`  ‚ÑπÔ∏è  ${unverifiedUsers} utilisateur(s) avec email non v√©rifi√©`);

  } catch (error) {
    console.error('  ‚ùå Erreur v√©rification base de donn√©es:', error);
  }
}

async function displayResults() {
  console.log('\n' + '‚ïê'.repeat(80));
  console.log('üìä R√âSULTATS DE L\'AUDIT DE S√âCURIT√â');
  console.log('‚ïê'.repeat(80) + '\n');

  if (issues.length === 0) {
    console.log('‚úÖ ‚úÖ ‚úÖ AUCUN PROBL√àME D√âTECT√â ! ‚úÖ ‚úÖ ‚úÖ\n');
    console.log('Votre configuration de s√©curit√© est correcte.\n');
    return;
  }

  const critical = issues.filter(i => i.severity === 'critical');
  const high = issues.filter(i => i.severity === 'high');
  const medium = issues.filter(i => i.severity === 'medium');
  const low = issues.filter(i => i.severity === 'low');

  console.log(`üî¥ CRITIQUE: ${critical.length}`);
  console.log(`üü† HAUTE:    ${high.length}`);
  console.log(`üü° MOYENNE:  ${medium.length}`);
  console.log(`üü¢ BASSE:    ${low.length}`);
  console.log(`TOTAL:      ${issues.length}\n`);

  if (critical.length > 0) {
    console.log('üî¥ PROBL√àMES CRITIQUES (√Ä CORRIGER IMM√âDIATEMENT) :');
    console.log('‚îÅ'.repeat(80));
    critical.forEach((issue, i) => {
      console.log(`\n${i + 1}. [${issue.category}] ${issue.issue}`);
      console.log(`   ‚Üí ${issue.fix}`);
    });
    console.log('\n');
  }

  if (high.length > 0) {
    console.log('üü† PROBL√àMES HAUTE PRIORIT√â :');
    console.log('‚îÅ'.repeat(80));
    high.forEach((issue, i) => {
      console.log(`\n${i + 1}. [${issue.category}] ${issue.issue}`);
      console.log(`   ‚Üí ${issue.fix}`);
    });
    console.log('\n');
  }

  if (medium.length > 0) {
    console.log('üü° PROBL√àMES MOYENNE PRIORIT√â :');
    console.log('‚îÅ'.repeat(80));
    medium.forEach((issue, i) => {
      console.log(`\n${i + 1}. [${issue.category}] ${issue.issue}`);
      console.log(`   ‚Üí ${issue.fix}`);
    });
    console.log('\n');
  }

  if (low.length > 0) {
    console.log('üü¢ PROBL√àMES BASSE PRIORIT√â :');
    console.log('‚îÅ'.repeat(80));
    low.forEach((issue, i) => {
      console.log(`\n${i + 1}. [${issue.category}] ${issue.issue}`);
      console.log(`   ‚Üí ${issue.fix}`);
    });
    console.log('\n');
  }

  console.log('‚ïê'.repeat(80));
  console.log('üìã PROCHAINES √âTAPES :');
  console.log('‚ïê'.repeat(80));
  console.log('\n1. Corriger TOUS les probl√®mes CRITIQUES imm√©diatement');
  console.log('2. Planifier correction des probl√®mes HAUTE priorit√©');
  console.log('3. Consulter SECURITE-COMPLETE.md pour plus de d√©tails');
  console.log('4. Relancer ce script apr√®s corrections\n');
}

async function main() {
  console.log('\nüîê AUDIT DE S√âCURIT√â - LAIA');
  console.log('‚ïê'.repeat(80) + '\n');

  await checkSecurityConfig();
  await checkDatabaseSecurity();
  await displayResults();

  await prisma.$disconnect();
}

main().catch((error) => {
  console.error('‚ùå Erreur durant l\'audit:', error);
  process.exit(1);
});
