import { PrismaClient } from '@prisma/client';
import bcrypt from 'bcryptjs';

const prisma = new PrismaClient();

async function updateDefaultPasswords() {
  console.log('üîê Mise √† jour des mots de passe par d√©faut...\n');

  try {
    // G√©n√©rer des mots de passe s√©curis√©s
    const securePasswords = {
      superAdmin: generateSecurePassword(20),
      admin: generateSecurePassword(16),
    };

    console.log('üìù NOUVEAUX MOTS DE PASSE G√âN√âR√âS :');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log(`Super Admin: ${securePasswords.superAdmin}`);
    console.log(`Admin:       ${securePasswords.admin}`);
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
    console.log('‚ö†Ô∏è  COPIEZ CES MOTS DE PASSE MAINTENANT ! Ils ne seront plus affich√©s.\n');

    // Hash des nouveaux mots de passe
    const hashedSuperAdmin = await bcrypt.hash(securePasswords.superAdmin, 10);
    const hashedAdmin = await bcrypt.hash(securePasswords.admin, 10);

    // Mise √† jour du Super Admin
    const superAdminUpdated = await prisma.user.updateMany({
      where: {
        email: 'superadmin@laiaskin.com',
        role: 'SUPER_ADMIN',
      },
      data: {
        password: hashedSuperAdmin,
      },
    });

    console.log(`‚úÖ Super Admin mis √† jour: ${superAdminUpdated.count} utilisateur(s)`);

    // Mise √† jour de l'Admin
    const adminUpdated = await prisma.user.updateMany({
      where: {
        email: 'admin@laiaskin.com',
        role: { in: ['ORG_ADMIN', 'ORG_OWNER'] },
      },
      data: {
        password: hashedAdmin,
      },
    });

    console.log(`‚úÖ Admin mis √† jour: ${adminUpdated.count} utilisateur(s)`);

    // Mise √† jour des clients avec mot de passe par d√©faut (si existants)
    const clientsUpdated = await prisma.user.updateMany({
      where: {
        role: 'CLIENT',
        // Ajouter ici une condition pour identifier les comptes avec mots de passe faibles
        // Par exemple : createdAt avant une certaine date, ou un flag sp√©cifique
      },
      data: {
        // Force password change on next login
        resetToken: 'FORCE_PASSWORD_CHANGE',
      },
    });

    if (clientsUpdated.count > 0) {
      console.log(`‚ö†Ô∏è  ${clientsUpdated.count} client(s) devront changer leur mot de passe √† la prochaine connexion`);
    }

    console.log('\n‚úÖ Mise √† jour termin√©e avec succ√®s !');
    console.log('\nüìã PROCHAINES √âTAPES :');
    console.log('1. Notez les nouveaux mots de passe en lieu s√ªr (gestionnaire de mots de passe)');
    console.log('2. Testez la connexion avec les nouveaux identifiants');
    console.log('3. Supprimez ce fichier script pour des raisons de s√©curit√©');
    console.log('4. Ne commitez JAMAIS les mots de passe dans Git\n');

  } catch (error) {
    console.error('‚ùå Erreur lors de la mise √† jour:', error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

function generateSecurePassword(length: number): string {
  const uppercase = 'ABCDEFGHJKLMNPQRSTUVWXYZ'; // Sans I, O
  const lowercase = 'abcdefghijkmnpqrstuvwxyz'; // Sans l, o
  const numbers = '23456789'; // Sans 0, 1
  const symbols = '@#$%&*+=!?';
  const all = uppercase + lowercase + numbers + symbols;

  let password = '';

  // Assurer au moins 1 de chaque type
  password += uppercase[Math.floor(Math.random() * uppercase.length)];
  password += lowercase[Math.floor(Math.random() * lowercase.length)];
  password += numbers[Math.floor(Math.random() * numbers.length)];
  password += symbols[Math.floor(Math.random() * symbols.length)];

  // Compl√©ter avec des caract√®res al√©atoires
  for (let i = password.length; i < length; i++) {
    password += all[Math.floor(Math.random() * all.length)];
  }

  // M√©langer le mot de passe
  return password.split('').sort(() => Math.random() - 0.5).join('');
}

// Ex√©cuter le script
updateDefaultPasswords()
  .catch(console.error);
