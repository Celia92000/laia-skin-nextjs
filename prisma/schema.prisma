generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// MULTI-TENANCY MODELS
// ============================================

enum UserRole {
  SUPER_ADMIN // Propri√©taire de la plateforme (acc√®s complet √† tous les instituts)
  ORG_ADMIN // Propri√©taire/Co-g√©rant d'un institut (acc√®s complet √† l'organisation)
  ACCOUNTANT // Comptable (acc√®s aux factures, paiements, stats financi√®res)
  LOCATION_MANAGER // Responsable d'un point de vente (acc√®s limit√© √† son emplacement)
  STAFF // Employ√© (acc√®s op√©rationnel limit√©)
  RECEPTIONIST // R√©ceptionniste (acc√®s limit√© √† la prise de RDV)
  CLIENT // Client (acc√®s espace client)
}

enum OrgType {
  SINGLE_LOCATION // Institut avec un seul point de vente
  MULTI_LOCATION // Institut avec plusieurs points de vente
}

enum OrgPlan {
  SOLO // 49‚Ç¨/mois - 1 emplacement, 1 utilisateur admin
  DUO // 99‚Ç¨/mois - 1 emplacement, 3 utilisateurs
  TEAM // 199‚Ç¨/mois - 3 emplacements, 10 utilisateurs
  PREMIUM // 399‚Ç¨/mois - Emplacements illimit√©s, utilisateurs illimit√©s
  STARTER // Ancien nom - √† supprimer apr√®s migration
  ESSENTIAL // Ancien nom - √† supprimer apr√®s migration
  PROFESSIONAL // Ancien nom - √† supprimer apr√®s migration
  ENTERPRISE // Ancien nom - √† supprimer apr√®s migration
}

// Formules d'abonnement configurables depuis le super-admin
model SubscriptionPlan {
  id      String  @id @default(cuid())
  planKey OrgPlan @unique // SOLO, DUO, TEAM, PREMIUM

  // Informations principales
  name        String // "Solo", "Duo", "Team", "Premium"
  displayName String // "Formule Solo" (affich√© dans l'interface)
  description String @db.Text // "Parfait pour un institut ind√©pendant..."

  // Tarification
  priceMonthly Int // Prix en euros (49, 69, 119, 179)
  priceYearly  Int? // Prix annuel (si diff√©rent du mensuel x12)

  // Limites
  maxLocations Int @default(1) // Nombre d'emplacements max
  maxUsers     Int @default(1) // Nombre d'utilisateurs max
  maxStorage   Int @default(5) // Stockage en GB

  // Features principales (JSON pour flexibilit√©)
  features String @default("[]") @db.Text // JSON array des features activ√©es

  // Highlights pour affichage marketing
  highlights String @default("[]") @db.Text // JSON array: ["CRM complet", "Blog SEO", ...]

  // Affichage
  isPopular     Boolean @default(false) // Badge "Populaire"
  isRecommended Boolean @default(false) // Badge "Recommand√©"
  displayOrder  Int     @default(0) // Ordre d'affichage (1, 2, 3, 4)

  // Stripe
  stripePriceId String? // ID du prix Stripe associ√©

  // Statut
  isActive Boolean @default(true) // Si false, plan non disponible √† la souscription

  // M√©tadonn√©es
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([planKey])
  @@index([isActive])
}

enum OrgStatus {
  PENDING // En attente d'activation (pay√© mais pas encore activ√©)
  ACTIVE // Organisation active
  TRIAL // P√©riode d'essai
  SUSPENDED // Suspendue (impay√©)
  CANCELLED // Annul√©e
}

enum LeadSource {
  WEBSITE // Formulaire site web LAIA Connect
  DEMO_FORM // Formulaire de r√©servation d√©mo
  REFERRAL // Bouche √† oreille / Parrainage
  MARKETING // Campagne marketing (email, pub, etc.)
  SOCIAL_MEDIA // R√©seaux sociaux
  EVENT // √âv√©nement / Salon
  PARTNER // Partenaire commercial
  DIRECT // Contact direct
  OTHER // Autre
}

enum PaymentProvider {
  STRIPE // Stripe Connect
  SUMUP // SumUp
  PAYPAL // PayPal
  POS_CLYO // Logiciel de caisse Clyo
  POS_ADORIA // Logiciel de caisse Adoria
  POS_SHORTCUTS // Logiciel de caisse Shortcuts
  POS_OTHER // Autre logiciel de caisse
}

// Organisation (Institut de beaut√©)
model Organization {
  id        String  @id @default(cuid())
  name      String // "Beaut√© √âternelle Paris"
  slug      String  @unique // "beaute-eternelle-paris"
  legalName String? // Raison sociale
  type      OrgType @default(SINGLE_LOCATION)

  // Domaine personnalis√©
  domain    String? @unique // "beaute-eternelle.fr"
  subdomain String  @unique // "beaute-eternelle"

  // Base de donn√©es d√©di√©e (chiffr√©e)
  databaseUrl String? // URL de la base de donn√©es PostgreSQL d√©di√©e

  // Abonnement
  plan           OrgPlan   @default(SOLO)
  status         OrgStatus @default(TRIAL)
  trialEndsAt    DateTime?
  subscriptionId String? // ID d'abonnement Stripe

  // CRM & Tracking
  leadSource  LeadSource? @default(WEBSITE) // Origine du prospect/client
  activatedAt DateTime? // Date d'activation manuelle par le super-admin
  convertedAt DateTime? // Date de conversion prospect ‚Üí client (paiement)

  // Limites du plan
  maxLocations Int @default(1)
  maxUsers     Int @default(1)
  maxStorage   Int @default(5) // En GB

  // Customisation des features (override par le super-admin)
  customFeaturesEnabled  String? @default("[]") @db.Text // JSON array des features ajout√©es manuellement
  customFeaturesDisabled String? @default("[]") @db.Text // JSON array des features retir√©es manuellement

  // Contact principal
  ownerFirstName String? // Pr√©nom du propri√©taire
  ownerLastName  String? // Nom du propri√©taire
  ownerEmail     String
  ownerPhone     String?

  // Informations l√©gales et facturation
  siret             String? // SIRET obligatoire pour facturation fran√ßaise
  tvaNumber         String? // Num√©ro TVA intracommunautaire
  billingEmail      String? // Email de facturation (si diff√©rent de ownerEmail)
  billingAddress    String? // Rue et num√©ro
  billingPostalCode String? // Code postal
  billingCity       String? // Ville
  billingCountry    String? @default("France") // Pays

  // Paiement g√©r√© par Stripe - Plus besoin de stocker les donn√©es bancaires
  sepaMandateRef  String? // R√©f√©rence unique du mandat (RUM) - pour affichage uniquement
  sepaMandateDate DateTime? // Date de signature du mandat

  // Prochaine facturation
  nextBillingDate DateTime? // Date du prochain pr√©l√®vement
  lastBillingDate DateTime? // Date du dernier pr√©l√®vement
  lastPaymentDate DateTime? // Date du dernier paiement r√©ussi
  monthlyAmount   Float? // Montant mensuel de l'abonnement

  // Stripe - Facturation de l'abonnement LAIA (compte Stripe de LAIA Platform)
  stripeCustomerId     String? @unique // ID du client Stripe pour facturer l'abonnement
  stripeSubscriptionId String? @unique // ID de l'abonnement Stripe actif

  // Stripe Connect - Paiements des clientes de l'institut (compte Stripe de l'institut)
  stripeConnectedAccountId String? @unique // ID du compte Stripe Connect de l'institut
  stripeOnboardingComplete Boolean @default(false) // Onboarding Stripe Connect termin√©
  stripeChargesEnabled     Boolean @default(false) // Peut accepter des paiements
  stripePayoutsEnabled     Boolean @default(false) // Peut recevoir des virements

  // Contrat d'abonnement
  contractNumber   String? // Num√©ro du contrat (ex: CONTRAT-LAIA-20250106-123456)
  contractPdfPath  String? // Chemin vers le PDF du contrat (uploads/documents/contracts/...)
  contractSignedAt DateTime? // Date de signature √©lectronique du contrat

  // Planity - Int√©gration OAuth pour r√©servations
  planityConnected    Boolean   @default(false) // Connect√© √† Planity
  planityAccessToken  String? // Token d'acc√®s (chiffr√©)
  planityRefreshToken String? // Token de rafra√Æchissement (chiffr√©)
  planityTokenExpiry  DateTime? // Date d'expiration du token
  planityBusinessId   String? // ID du salon sur Planity
  planityBusinessName String? // Nom du salon sur Planity

  // Treatwell - Int√©gration OAuth pour r√©servations
  treatwellConnected    Boolean   @default(false) // Connect√© √† Treatwell
  treatwellAccessToken  String? // Token d'acc√®s (chiffr√©)
  treatwellRefreshToken String? // Token de rafra√Æchissement (chiffr√©)
  treatwellTokenExpiry  DateTime? // Date d'expiration du token
  treatwellVenueId      String? // ID du salon sur Treatwell
  treatwellVenueName    String? // Nom du salon sur Treatwell

  // PayPal - Int√©gration OAuth pour paiements
  paypalConnected    Boolean   @default(false) // Connect√© √† PayPal
  paypalAccessToken  String? // Token d'acc√®s (chiffr√©)
  paypalRefreshToken String? // Token de rafra√Æchissement (chiffr√©)
  paypalTokenExpiry  DateTime? // Date d'expiration du token
  paypalMerchantId   String? // ID du compte marchand PayPal
  paypalEmail        String? // Email du compte PayPal

  // SumUp - Int√©gration OAuth pour paiements
  sumupConnected    Boolean   @default(false) // Connect√© √† SumUp
  sumupAccessToken  String? // Token d'acc√®s (chiffr√©)
  sumupRefreshToken String? // Token de rafra√Æchissement (chiffr√©)
  sumupTokenExpiry  DateTime? // Date d'expiration du token
  sumupMerchantCode String? // Code marchand SumUp
  sumupCurrency     String? // Devise par d√©faut

  // Google Calendar - Int√©gration OAuth pour synchronisation
  googleCalendarConnected    Boolean   @default(false) // Connect√© √† Google Calendar
  googleCalendarAccessToken  String? // Token d'acc√®s (chiffr√©)
  googleCalendarRefreshToken String? // Token de rafra√Æchissement (chiffr√©)
  googleCalendarTokenExpiry  DateTime? // Date d'expiration du token
  googleCalendarId           String? // ID du calendrier principal
  googleCalendarEmail        String? // Email du compte Google

  // Template et versioning (pour mod√®le centralis√© LAIA)
  templateVersion    String    @default("1.0.0") // Version du template utilis√©e
  lastTemplateUpdate DateTime? // Derni√®re mise √† jour du template

  // Features activ√©es selon le forfait (LAIA Connect)
  featureBlog        Boolean @default(false) // Blog (TEAM+)
  featureProducts    Boolean @default(false) // Boutique produits (TEAM+)
  featureCRM         Boolean @default(false) // CRM & Leads (DUO+)
  featureEmailing    Boolean @default(false) // Email Marketing (DUO+)
  featureWhatsApp    Boolean @default(false) // WhatsApp Marketing (TEAM+)
  featureSMS         Boolean @default(false) // SMS Marketing (TEAM+)
  featureSocialMedia Boolean @default(false) // R√©seaux sociaux (TEAM+)
  featureStock       Boolean @default(false) // Gestion de stock avanc√© (PREMIUM)
  featureFormations  Boolean @default(false) // Vente de formations (TEAM+)
  featureShop        Boolean @default(false) // E-commerce complet (TEAM+)

  // Options suppl√©mentaires payantes (add-ons)
  addons String? @default("{}") @db.Text // JSON stockant les addons actifs et historique

  // Configuration
  config OrganizationConfig?

  // Relations
  locations               Location[]
  users                   User[]
  services                Service[]
  products                Product[]
  blogPosts               BlogPost[]
  paymentSettings         PaymentSettings?
  loyaltyProgram          LoyaltyProgramSettings?
  bookingSettings         BookingSettings?
  superAdminNotifications SuperAdminNotification[] // Notifications super admin
  auditLogs               AuditLog[] // Logs d'audit
  invoices                Invoice[] // Factures
  payments                Payment[] // Paiements re√ßus
  supportTickets          SupportTicket[] // Tickets de support
  subscriptionPromoCodes  SubscriptionPromoCode[]  @relation("SubscriptionPromoUsage") // Codes promo utilis√©s
  testimonials            Testimonial[]            @relation("OrganizationTestimonials") // T√©moignages
  giftCards               GiftCard[]               @relation("OrganizationGiftCards") // Cartes cadeaux
  reviews                 Review[]                 @relation("OrganizationReviews") // Avis clients
  googleReviews           GoogleReview[] // Avis Google synchronis√©s

  // CRM Relations
  convertedLeads Lead[] // Leads convertis en clients
  segments       ClientSegment[] // Segments de clients
  funnels        ConversionFunnel[] // Funnels de conversion

  // API Tokens (r√©seaux sociaux, paiements, etc.)
  apiTokens ApiToken[] // Tokens API de l'organisation

  // Templates email
  emailTemplates EmailTemplate[] // Templates email de l'organisation

  // SMS Marketing (TEAM + PREMIUM)
  smsCredits          Int           @default(0) // Cr√©dits SMS restants (1 cr√©dit = 1 SMS)
  smsTotalPurchased   Int           @default(0) // Total de SMS achet√©s (historique)
  smsLastPurchaseDate DateTime? // Date du dernier achat de cr√©dits SMS
  smsCampaigns        SMSCampaign[] // Campagnes SMS
  smsTemplates        SMSTemplate[] // Templates SMS
  smsLogs             SMSLog[] // Historique SMS

  // Programme de parrainage - Configuration
  referralEnabled         Boolean @default(true) // Programme de parrainage activ√©
  referralRewardType      String  @default("FIXED") // Type de r√©compense: "FIXED" (‚Ç¨) ou "PERCENTAGE" (%)
  referralRewardAmount    Float   @default(20.0) // Montant de la r√©compense (20‚Ç¨ ou 20%)
  referralMinimumPurchase Float   @default(0.0) // Montant minimum d'achat pour d√©bloquer la r√©compense
  referralReferrerReward  Float   @default(20.0) // R√©compense pour le parrain
  referralReferredReward  Float   @default(10.0) // R√©compense pour le filleul
  referralTermsUrl        String? // URL vers les CGU du parrainage
  referralEmailTemplate   String? @db.Text // Template email d'invitation personnalis√©

  // Template de site web
  websiteTemplateId String?
  websiteTemplate   WebsiteTemplate? @relation("OrganizationWebsiteTemplate", fields: [websiteTemplateId], references: [id])

  // Onboarding
  isOnboarded       Boolean @default(false) // Configuration initiale termin√©e
  temporaryPassword String? // Mot de passe temporaire initial (chiffr√©) - effac√© une fois que l'admin change son mot de passe

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Rapports sauvegard√©s
  savedReports SavedReport[]

  // Workflows et churn management
  workflowExecutions   WorkflowExecution[]
  churnRiskProfile     ChurnRiskProfile?
  cancellationFeedback CancellationFeedback[]

  // Multi-tenant relations
  stocks                 Stock[]
  referrals              Referral[]
  notifications          Notification[]
  emailHistory           EmailHistory[]
  discounts              Discount[]
  newsletterSubscribers  NewsletterSubscriber[]
  serviceCategories      ServiceCategory[]
  serviceSubcategories   ServiceSubcategory[]

  // Syst√®me de quotas et usage
  usage        OrganizationUsage?
  usageHistory OrganizationUsageHistory[]

  @@index([slug])
  @@index([subdomain])
  @@index([status])
}

// Configuration d'une organisation (remplace SiteConfig)
model OrganizationConfig {
  id             String @id @default(cuid())
  organizationId String @unique

  // Informations g√©n√©rales
  siteName        String  @default("Mon Institut de Beaut√©")
  siteTagline     String? @default("Institut de Beaut√© & Bien-√™tre")
  siteDescription String?

  // Contact
  email        String? @default("contact@mon-institut.fr")
  contactEmail String? // Email de contact principal (alias de email)
  phone        String? @default("+33 6 00 00 00 00")
  address      String?
  city         String?
  postalCode   String?
  country      String? @default("France")

  // R√©seaux sociaux
  facebook  String?
  instagram String?
  tiktok    String?
  whatsapp  String?
  linkedin  String?
  youtube   String?

  // Apparence
  primaryColor   String? @default("#d4b5a0")
  secondaryColor String? @default("#2c3e50")
  accentColor    String? @default("#20b2aa")
  logoUrl        String?
  faviconUrl     String?

  // Typographie
  fontFamily   String? @default("Inter")
  headingFont  String? @default("Playfair Display")
  baseFontSize String? @default("16px")
  headingSize  String? @default("2.5rem")

  // Horaires (JSON)
  businessHours String? // {"lundi": "9h-18h", ...}

  // G√©olocalisation
  latitude      String?
  longitude     String?
  googleMapsUrl String?

  // Page d'accueil
  heroTitle    String?
  heroSubtitle String?
  heroImage    String?
  heroVideo    String? // URL vid√©o pour hero (prioritaire sur heroImage si pr√©sent)
  aboutText    String?

  // Fondateur/Fondatrice
  founderName   String?
  founderTitle  String?
  founderQuote  String? @db.Text
  founderImage  String?
  aboutIntro    String? @db.Text
  aboutParcours String? @db.Text

  // T√©moignages et formations (JSON)
  testimonials String? @db.Text
  formations   String? @db.Text

  // CGV et mentions l√©gales
  termsAndConditions String? @db.Text
  privacyPolicy      String? @db.Text
  legalNotice        String? @db.Text

  // Emails
  emailSignature   String?
  welcomeEmailText String? @db.Text

  // Informations l√©gales
  legalName String? // Nom l√©gal de l'entreprise (ex: SARL Mon Institut)
  siret     String?
  siren     String?
  tvaNumber String?
  apeCode   String?
  rcs       String?
  capital   String?
  legalForm String?

  // Assurance
  insuranceCompany  String?
  insuranceContract String?
  insuranceAddress  String?

  // Banque
  bankName String?
  bankIban String?
  bankBic  String?

  // Repr√©sentant l√©gal
  legalRepName  String?
  legalRepTitle String?

  // Tracking et Analytics
  googleAnalyticsId      String?
  facebookPixelId        String?
  metaVerificationCode   String?
  googleVerificationCode String?

  // Chat en direct (Crisp)
  crispWebsiteId String? // Website ID de Crisp
  crispEnabled   Boolean @default(false)

  // SEO Global
  defaultMetaTitle       String?
  defaultMetaDescription String?
  defaultMetaKeywords    String?

  // Design avanc√© (niveau 2 - personnalisation automatis√©e)
  // Template de page d'accueil choisi (classic, modern, elegant, minimal, bold)
  homeTemplate String? @default("classic")

  // Configuration des sections homepage (JSON)
  // Ex: [{"id": "hero", "active": true, "order": 1}, {"id": "services", "active": true, "order": 2}, ...]
  homeSections String? @default("[]") @db.Text

  // Configuration du footer (JSON)
  // Ex: {"columns": 3, "showSocial": true, "showNewsletter": true, "links": [...]}
  footerConfig String? @default("{}") @db.Text

  // Couleurs √©tendues (JSON)
  // Ex: {"buttonHover": "#...", "background": "#...", "textMuted": "#..."}
  extendedColors String? @default("{}") @db.Text

  // Template tracking (LAIA Connect)
  // JSON object listing which fields are customized vs inherited
  // Ex: {"primaryColor": "customized", "heroTitle": "template", ...}
  customizedFields String? @default("{}") @db.Text

  // Google My Business - Configuration par organisation
  googlePlaceId         String? // ID unique de l'√©tablissement Google (ex: ChIJxxx...)
  googleBusinessUrl     String? // URL Google Maps/Business profile
  googleApiKey          String? // Cl√© API (chiffr√©e) - optionnel
  lastGoogleSync        DateTime? // Derni√®re synchronisation Google Reviews
  autoSyncGoogleReviews Boolean   @default(false) // Activer sync automatique quotidienne

  // Google My Business - OAuth2 tokens
  googleBusinessConnected    Boolean   @default(false) // Connect√© √† Google My Business
  googleBusinessAccessToken  String?   @db.Text // Token d'acc√®s OAuth2 (chiffr√©)
  googleBusinessRefreshToken String?   @db.Text // Token de rafra√Æchissement (chiffr√©)
  googleBusinessTokenExpiry  DateTime? // Date d'expiration du token
  googleBusinessEmail        String? // Email du compte Google connect√©
  googleBusinessAccountId    String? // ID du compte Google My Business

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// Point de vente / Emplacement
model Location {
  id             String @id @default(cuid())
  organizationId String

  name String // "Beaut√© √âternelle - Champs-√âlys√©es"
  slug String // "champs-elysees"

  // Adresse
  address    String
  city       String
  postalCode String
  country    String  @default("France")
  latitude   String?
  longitude  String?

  // Contact
  phone String?
  email String?

  // Horaires sp√©cifiques (si diff√©rents de l'organisation)
  businessHours String? // JSON

  // Configuration
  isMainLocation Boolean @default(false)
  active         Boolean @default(true)

  // Relations
  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  staff        UserLocation[]
  workingHours WorkingHours[]
  blockedSlots BlockedSlot[]
  reservations Reservation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([active])
}

// Param√®tres de paiement d'une organisation
model PaymentSettings {
  id             String @id @default(cuid())
  organizationId String @unique

  // Fournisseur principal
  primaryProvider PaymentProvider @default(STRIPE)

  // Stripe Connect
  stripeAccountId           String? // ID du compte Stripe Connect
  stripePublicKey           String?
  stripeSecretKey           String? // Chiffr√©
  stripeConnected           Boolean @default(false)
  stripeOnboardingCompleted Boolean @default(false)

  // Autres fournisseurs
  sumupApiKey     String? // Chiffr√©
  paypalClientId  String?
  paypalSecretKey String? // Chiffr√©

  // Logiciel de caisse (POS)
  posProvider    PaymentProvider?
  posApiUrl      String?
  posApiKey      String? // Chiffr√©
  posWebhookUrl  String?
  posSyncEnabled Boolean          @default(false)
  posLastSync    DateTime?

  // Frais de plateforme (pour future mon√©tisation)
  platformFeePercent Float @default(0)
  platformFeeFixed   Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// Programme de fid√©lit√© d'une organisation
model LoyaltyProgramSettings {
  id             String @id @default(cuid())
  organizationId String @unique

  // Activation
  isEnabled Boolean @default(false)

  // Configuration des points
  pointsPerEuro        Float @default(1) // 1 point par euro d√©pens√©
  pointsValue          Float @default(0.01) // 1 point = 0.01‚Ç¨
  minPointsToRedeem    Int   @default(100) // Minimum 100 points pour utiliser
  pointsExpirationDays Int? // null = pas d'expiration

  // Paliers VIP
  bronzeThreshold   Float @default(0) // D√®s l'inscription
  silverThreshold   Float @default(500) // 500‚Ç¨ d√©pens√©s
  goldThreshold     Float @default(1500) // 1500‚Ç¨ d√©pens√©s
  platinumThreshold Float @default(5000) // 5000‚Ç¨ d√©pens√©s

  // Avantages par palier (JSON)
  bronzePerks   String? // [{"type": "discount", "value": 5}]
  silverPerks   String?
  goldPerks     String?
  platinumPerks String?

  // Programme de parrainage
  referralEnabled      Boolean @default(true)
  referralRewardAmount Float   @default(20) // 20‚Ç¨ de r√©duction
  referralMinimumSpend Float   @default(0) // D√©pense minimum du filleul

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// Param√®tres de r√©servation d'une organisation
model BookingSettings {
  id             String @id @default(cuid())
  organizationId String @unique

  // Contraintes de r√©servation
  minAdvanceBookingHours    Int @default(2) // Minimum 2h √† l'avance
  maxAdvanceBookingDays     Int @default(30) // Maximum 30 jours √† l'avance
  cancellationDeadlineHours Int @default(24) // Annulation gratuite 24h avant

  // Options
  allowStaffSelection      Boolean @default(true) // Client peut choisir son praticien
  requireLocationSelection Boolean @default(false) // Obligatoire si multi-emplacements
  allowOnlinePayment       Boolean @default(true)
  requireDepositPercent    Float? // % d'acompte requis

  // Notifications automatiques
  sendConfirmationEmail Boolean @default(true)
  sendReminder24h       Boolean @default(true)
  sendReminder2h        Boolean @default(false)
  sendReviewRequest     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// Utilisateur (client ou staff)
model User {
  id             String    @id @default(cuid())
  organizationId String? // null pour SUPER_ADMIN
  email          String
  password       String? // Nullable pour les connexions OAuth (Google, etc.)
  name           String
  phone          String?
  role           UserRole  @default(CLIENT)
  emailVerified  DateTime? // NextAuth - Date de v√©rification de l'email
  image          String? // NextAuth - Photo de profil (Google, etc.)

  // Permissions personnalis√©es (JSON)
  customPermissions String? // {"canViewRevenue": false, "canDeleteReservations": true}

  // Visibilit√© et disponibilit√© (pour le staff)
  isVisible   Boolean @default(true) // Visible dans la liste des praticiens
  isAvailable Boolean @default(true) // Disponible pour les r√©servations

  // Client data
  loyaltyPoints Int       @default(0)
  totalSpent    Float     @default(0)
  adminNotes    String?
  allergies     String?
  birthDate     DateTime?
  lastVisit     DateTime?
  medicalNotes  String?
  preferences   String?
  skinType      String?

  // Auth
  resetToken       String?
  resetTokenExpiry DateTime?
  lastLoginAt      DateTime? // Derni√®re connexion

  // RGPD - Droit √† l'oubli (Article 17)
  deletionRequestedAt DateTime? // Date de demande de suppression
  scheduledDeletionAt DateTime? // Date de suppression effective (30 jours apr√®s demande)

  // Relations
  organization      Organization?     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  locations         UserLocation[] // Emplacements assign√©s (pour le staff)
  evolutions        ClientEvolution[]
  loyaltyHistory    LoyaltyHistory[]
  loyaltyProfile    LoyaltyProfile?
  reservations      Reservation[]     @relation("UserReservations")
  staffReservations Reservation[]     @relation("StaffReservations")
  reviews           Review[]
  notifications     Notification[]
  referralsMade     Referral[]        @relation("ReferralReferrer")
  referredBy        Referral?         @relation("ReferralReferred")
  discounts         Discount[]

  // NextAuth Relations
  accounts Account[] // Connexions OAuth (Google, etc.)
  sessions Session[] // Sessions NextAuth

  // CRM Relations
  assignedLeads    Lead[]
  leadInteractions LeadInteraction[]
  contactFormLeads ContactFormLead[]
  demoSlots        DemoSlot[]        @relation("DemoSlots")
  funnelEntries    FunnelEntry[] // Progression dans les funnels
  orders           Order[]
  payments         Payment[]
  stockMovements   StockMovement[]
  giftCards        GiftCard[]        @relation("GiftCardPurchaser")
  auditLogs        AuditLog[] // Logs d'actions (pour SUPER_ADMIN)
  ticketsCreated   SupportTicket[]   @relation("TicketCreator")
  ticketsAssigned  SupportTicket[]   @relation("TicketAssignee")
  ticketMessages   TicketMessage[]
  platformNews     PlatformNews[] // Nouveaut√©s LAIA Connect cr√©√©es

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, email]) // Multi-tenant: email unique par organization
  @@index([email])
  @@index([organizationId])
  @@index([role])
  @@index([createdAt])
}

// Association User <-> Location (Many-to-Many)
model UserLocation {
  id         String @id @default(cuid())
  userId     String
  locationId String

  // R√¥le sp√©cifique √† cet emplacement (peut diff√©rer du r√¥le global)
  roleAtLocation UserRole @default(STAFF)

  // Permissions sp√©cifiques
  canManageSchedule Boolean @default(false)
  canViewRevenue    Boolean @default(false)
  canManageStock    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([userId, locationId])
  @@index([userId])
  @@index([locationId])
}

model Reservation {
  id                 String          @id @default(cuid())
  organizationId     String
  locationId         String? // null si la r√©servation n'est pas li√©e √† un emplacement sp√©cifique
  userId             String
  staffId            String? // Praticien assign√©
  serviceId          String?
  services           String          @default("[]") // JSON array of service IDs
  packages           String          @default("{}") // JSON object with service packages (single/forfait/abonnement)
  isSubscription     Boolean         @default(false) // True si c'est un abonnement mensuel
  date               DateTime
  time               String
  totalPrice         Float
  status             String          @default("pending")
  source             String          @default("site")
  notes              String?
  paymentStatus      String          @default("unpaid")
  paymentDate        DateTime?
  paymentAmount      Float?
  paymentMethod      String?
  stripePaymentId    String? // ID du paiement Stripe (payment_intent_xxx)
  stripeSessionId    String? // ID de la session Stripe Checkout
  invoiceNumber      String?
  paymentNotes       String?
  reviewEmailSent    Boolean         @default(false)
  reviewWhatsAppSent Boolean         @default(false)
  reminderSent       Boolean         @default(false)
  reminder24hSent    Boolean         @default(false)
  reminder2hSent     Boolean         @default(false)
  rescheduledFrom    String? // ID de la r√©servation d'origine si reprogramm√©e
  rescheduledTo      String? // ID de la nouvelle r√©servation si reprogramm√©e
  rescheduledAt      DateTime? // Date de la reprogrammation
  giftCardId         String? // ID de la carte cadeau utilis√©e pour cette r√©servation
  giftCardUsedAmount Float? // Montant de la carte cadeau utilis√©
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  location           Location?       @relation(fields: [locationId], references: [id])
  user               User            @relation("UserReservations", fields: [userId], references: [id])
  staff              User?           @relation("StaffReservations", fields: [staffId], references: [id])
  service            Service?        @relation(fields: [serviceId], references: [id])
  giftCard           GiftCard?       @relation("GiftCardReservations", fields: [giftCardId], references: [id])
  review             Review?
  stockMovements     StockMovement[]

  @@index([organizationId])
  @@index([locationId])
  @@index([userId])
  @@index([staffId])
  @@index([date])
  @@index([status])
  @@index([createdAt])
}

// Blocages r√©currents du calendrier (ex: ferm√© tous les dimanches)
model RecurringBlock {
  id             String   @id @default(cuid())
  organizationId String // üîí CRITIQUE : Isolation multi-tenant
  type           String // 'daily' | 'weekly' | 'monthly'
  dayOfWeek      Int? // 0-6 pour weekly (0=dimanche, 1=lundi, etc.)
  dayOfMonth     Int? // 1-31 pour monthly
  timeSlots      String? // JSON array de cr√©neaux horaires sp√©cifiques
  allDay         Boolean  @default(false)
  startTime      String? // Format HH:mm
  endTime        String? // Format HH:mm
  reason         String? // Raison du blocage (ex: "Ferm√©", "Cong√©s", etc.)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@index([type])
}

model Service {
  id                String  @id @default(cuid())
  organizationId    String
  slug              String  @default("")
  name              String
  shortDescription  String  @default("")
  description       String
  metaTitle         String?
  metaDescription   String?
  keywords          String?
  price             Float
  launchPrice       Float?
  promoPrice        Float?
  forfaitPrice      Float?
  forfaitPromo      Float?
  duration          Int
  benefits          String? // JSON
  process           String? // JSON - Deprecated, use protocol instead
  protocol          String? // JSON - Array of {title, duration, desc}
  recommendations   String?
  contraindications String?
  mainImage         String?
  imageSettings     String? // JSON pour objectFit, position, zoom
  imagePositionX    Int?    @default(50) // Position horizontale en %
  imagePositionY    Int?    @default(50) // Position verticale en %
  imageObjectFit    String? @default("cover") // "cover" ou "contain"
  gallery           String? // JSON
  videoUrl          String?
  canBeOption       Boolean @default(false)
  category          String? // DEPRECATED: Utiliser categoryId et subcategoryId
  categoryId        String? // Nouvelle relation vers ServiceCategory
  subcategoryId     String? // Relation vers ServiceSubcategory
  order             Int     @default(0)
  active            Boolean @default(true)
  featured          Boolean @default(false)

  // Template tracking (LAIA Connect)
  templateSourceId String? // ID du service template d'origine
  isCustomized     Boolean @default(false) // true si modifi√© par le client

  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  organization       Organization?       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  reservations       Reservation[]
  stockLinks         ServiceStock[] // Relation avec le stock
  serviceCategory    ServiceCategory?    @relation("ServiceToCategory", fields: [categoryId], references: [id])
  serviceSubcategory ServiceSubcategory? @relation("ServiceToSubcategory", fields: [subcategoryId], references: [id])

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([categoryId])
  @@index([subcategoryId])
  @@index([active, featured])
  @@index([active, order])
  @@index([categoryId, active])
}

model LoyaltyProfile {
  id                      String           @id @default(cuid())
  userId                  String           @unique
  // L'organisation est d√©termin√©e via user.organizationId
  points                  Int              @default(0)
  tier                    String           @default("BRONZE") // BRONZE, SILVER, GOLD, PLATINUM
  individualServicesCount Int              @default(0)
  packagesCount           Int              @default(0)
  totalSpent              Float            @default(0)
  availableDiscounts      String           @default("[]") // JSON
  referralCode            String?          @unique // Code parrainage unique du client
  referredBy              String? // Code de parrainage utilis√© lors de l'inscription
  totalReferrals          Int              @default(0) // Nombre de parrainages effectu√©s
  lastVisit               DateTime?
  notes                   String?          @db.Text // Notes administratives sur le client
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  user                    User             @relation(fields: [userId], references: [id])
  history                 LoyaltyHistory[]
}

model LoyaltyHistory {
  id            String          @id @default(cuid())
  userId        String
  profileId     String?
  action        String
  points        Int             @default(0)
  description   String
  reservationId String?
  orderId       String? // Pour achats produits/formations
  createdAt     DateTime        @default(now())
  user          User            @relation(fields: [userId], references: [id])
  profile       LoyaltyProfile? @relation(fields: [profileId], references: [id])
}

model Referral {
  id               String       @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  referrerUserId   String // ID de l'utilisateur parrain
  referralCode     String       @unique // Code unique de parrainage
  referredEmail    String? // Email du filleul avant inscription
  referredName     String? // Nom du filleul
  referredUserId   String?      @unique // ID du filleul une fois inscrit
  status           String       @default("pending") // pending, used, rewarded
  rewardAmount     Float        @default(20) // Montant de la r√©compense en euros
  rewardUsedAt     DateTime? // Date d'utilisation de la r√©compense
  firstServiceDate DateTime? // Date du premier soin du filleul
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  referrer User  @relation("ReferralReferrer", fields: [referrerUserId], references: [id])
  referred User? @relation("ReferralReferred", fields: [referredUserId], references: [id])

  @@index([organizationId])
}

model BlogPost {
  id              String   @id @default(cuid())
  organizationId  String
  slug            String
  title           String
  excerpt         String
  content         String
  category        String
  author          String   @default("LAIA SKIN Institut")
  readTime        String   @default("5 min")
  featured        Boolean  @default(false)
  published       Boolean  @default(true)
  mainImage       String?
  gallery         String? // JSON
  tags            String? // JSON
  metaTitle       String?
  metaDescription String?
  publishedAt     DateTime @default(now())

  // Template tracking (LAIA Connect)
  templateSourceId String? // ID de l'article template d'origine
  isCustomized     Boolean @default(false) // true si modifi√© par le client

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([published])
}

model ClientEvolution {
  id             String   @id @default(cuid())
  userId         String
  sessionNumber  Int
  serviceName    String
  sessionDate    DateTime
  beforePhoto    String?
  afterPhoto     String?
  videoUrl       String?
  improvements   String? // JSON
  clientFeedback String?
  adminNotes     String?
  skinAnalysis   String? // JSON
  treatedAreas   String? // JSON
  productsUsed   String? // JSON
  hydrationLevel Int?
  elasticity     Int?
  pigmentation   Int?
  wrinkleDepth   Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id])
}

model Review {
  id             String        @id @default(cuid())
  organizationId String // Organisation (multi-tenant) - OBLIGATOIRE
  userId         String?       // Optionnel pour permettre avis anonymes/import√©s
  reservationId  String?       @unique
  orderId        String?       @unique // Pour avis sur produits/formations
  serviceName    String?
  itemType       String? // "service", "product", "formation"
  itemId         String? // ID du service/produit/formation
  itemName       String? // Nom du service/produit/formation
  rating         Int
  comment        String
  satisfaction   Int           @default(5)
  photos         String        @default("[]") // JSON array of photo URLs
  response       String?
  approved       Boolean       @default(false)
  featured       Boolean       @default(false)
  source         String        @default("site") // site, email, whatsapp, google
  googleReview   Boolean       @default(false)
  googleUrl      String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation("OrganizationReviews", fields: [organizationId], references: [id])
  user           User?         @relation(fields: [userId], references: [id])
  reservation    Reservation?  @relation(fields: [reservationId], references: [id])
  order          Order?        @relation(fields: [orderId], references: [id])

  @@index([organizationId])
}

model Notification {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  type           String // reminder, promotion, loyalty, birthday, etc.
  title          String
  message        String
  read           Boolean      @default(false)
  actionUrl      String?
  createdAt      DateTime     @default(now())
  user           User         @relation(fields: [userId], references: [id])

  @@index([organizationId])
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlockedSlot {
  id         String    @id @default(cuid())
  locationId String
  date       DateTime
  time       String? // Si null, toute la journ√©e est bloqu√©e
  allDay     Boolean   @default(false)
  reason     String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  location   Location? @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([locationId])
}

model WorkingHours {
  id         String    @id @default(cuid())
  locationId String
  dayOfWeek  Int // 0 = Dimanche, 1 = Lundi, etc.
  startTime  String // Format: "14:00"
  endTime    String // Format: "20:00"
  isOpen     Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  location   Location? @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([locationId])
}

model Package {
  id             String   @id @default(cuid())
  organizationId String? // Organisation (multi-tenant)
  name           String
  description    String
  services       String // JSON array of service IDs
  price          Float
  validDays      Int      @default(90)
  maxUses        Int?
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
}

// Lead - Mod√®le basique de capture formulaire (conserv√© pour compatibilit√©)
// Pour le CRM complet, voir le mod√®le Lead CRM plus bas
model ContactFormLead {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  phone     String?
  subject   String?
  message   String?
  source    String   @default("contact_form") // contact_form, instagram, facebook, phone
  status    String   @default("new") // new, contacted, qualified, converted, lost
  notes     String?
  userId    String? // Lien vers User si converti en client
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])
}

model SiteConfig {
  id             String  @id @default(cuid())
  organizationId String? // Organisation (multi-tenant)

  // Informations g√©n√©rales
  siteName        String  @default("Mon Institut de Beaut√©")
  siteTagline     String? @default("Institut de Beaut√© & Bien-√™tre")
  siteDescription String?

  // Contact
  email      String? @default("contact@mon-institut.fr")
  phone      String? @default("+33 6 00 00 00 00")
  address    String?
  city       String?
  postalCode String?
  country    String? @default("France")

  // R√©seaux sociaux
  facebook  String?
  instagram String?
  tiktok    String?
  whatsapp  String?
  linkedin  String?
  youtube   String?

  // Apparence
  primaryColor   String? @default("#d4b5a0")
  secondaryColor String? @default("#2c3e50")
  accentColor    String? @default("#20b2aa")
  logoUrl        String?
  faviconUrl     String?

  // Typographie
  fontFamily   String? @default("Inter") // Police principale
  headingFont  String? @default("Playfair Display") // Police des titres
  baseFontSize String? @default("16px") // Taille de base
  headingSize  String? @default("2.5rem") // Taille des titres

  // Horaires (JSON)
  businessHours String? // {"lundi": "9h-18h", "mardi": "9h-18h", ...}

  // G√©olocalisation pour SEO Schema.org
  latitude      String?
  longitude     String?
  googleMapsUrl String?

  // Page d'accueil
  heroTitle    String?
  heroSubtitle String?
  heroImage    String?
  heroVideo    String? // URL vid√©o pour hero (prioritaire sur heroImage si pr√©sent)
  aboutText    String?

  // Fondateur/Fondatrice
  founderName   String? // Ex: "La√Øa Gherbi"
  founderTitle  String? // Ex: "Fondatrice & Experte en soins esth√©tiques"
  founderQuote  String? @db.Text // Citation du fondateur
  founderImage  String? // Photo du fondateur
  aboutIntro    String? @db.Text // Texte d'introduction page √Ä propos
  aboutParcours String? @db.Text // Parcours professionnel

  // T√©moignages (JSON array)
  testimonials String? @db.Text // [{"name": "...", "text": "...", "rating": 5}]

  // Formations (JSON array pour page √Ä propos)
  formations String? @db.Text // [{"name": "CAP Esth√©tique", "year": "2010"}]

  // CGV et mentions l√©gales
  termsAndConditions String? @db.Text
  privacyPolicy      String? @db.Text
  legalNotice        String? @db.Text

  // Emails
  emailSignature   String?
  welcomeEmailText String? @db.Text

  // Informations l√©gales (ajout√©es pour white-labeling)
  legalName String? // Raison sociale
  siret     String?
  siren     String?
  tvaNumber String? // N¬∞ TVA intracommunautaire
  apeCode   String? // Code APE/NAF
  rcs       String? // RCS
  capital   String? // Capital social
  legalForm String? // SARL, SAS, EURL, etc.

  // Assurance
  insuranceCompany  String?
  insuranceContract String?
  insuranceAddress  String? // Adresse de l'assureur

  // Banque (pour mentions l√©gales compl√®tes)
  bankName String?
  bankIban String?
  bankBic  String?

  // Repr√©sentant l√©gal
  legalRepName  String?
  legalRepTitle String? // G√©rant(e), Pr√©sident(e), etc.

  // URLs et domaines
  customDomain String? @unique
  baseUrl      String? // URL de base du site (ex: https://mon-institut.fr)

  // Tracking et Analytics
  googleAnalyticsId      String?
  facebookPixelId        String?
  metaVerificationCode   String?
  googleVerificationCode String?

  // SEO Global
  defaultMetaTitle       String?
  defaultMetaDescription String?
  defaultMetaKeywords    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([createdAt]) // Index pour optimiser findFirst()
}

model EmailHistory {
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  id           String         @id @default(cuid())
  from         String         @default("contact@laiaskininstitut.fr")
  to           String // Email ou liste d'emails s√©par√©s par virgule
  subject      String
  content      String         @db.Text // Contenu du message
  template     String? // Template utilis√©
  status       String         @default("sent") // sent, failed, pending, delivered, received, opened, clicked, bounced
  direction    String         @default("outgoing") // outgoing, incoming
  campaignId   String?
  userId       String? // Client associ√©
  errorMessage String?
  openedAt     DateTime?
  clickedAt    DateTime?
  openCount    Int            @default(0) // Nombre d'ouvertures
  clickCount   Int            @default(0) // Nombre de clics
  resendId     String? // ID Resend pour le tracking
  messageId    String? // Message-ID de l'email
  archived     Boolean        @default(false) // Pour archiver les conversations
  createdAt    DateTime       @default(now())
  campaign     EmailCampaign? @relation(fields: [campaignId], references: [id])
  @@index([organizationId])
}

model EmailCampaign {
  id             String            @id @default(cuid())
  name           String
  subject        String
  content        String
  template       String?
  recipients     String // JSON array des destinataires
  recipientCount Int               @default(0)
  status         String            @default("draft") // draft, scheduled, sent, cancelled
  scheduledAt    DateTime?
  sentAt         DateTime?
  openRate       Float             @default(0)
  clickRate      Float             @default(0)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  emails         EmailHistory[]
  segments       CampaignSegment[]
}

model Discount {
  id                 String       @id @default(cuid())
  organizationId     String
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId             String
  type               String // service_5, package_9, birthday, referral, postponed
  amount             Float
  status             String       @default("available") // available, used, expired, postponed
  originalReason     String // Raison initiale (ex: "5√®me soin", "9√®me s√©ance", "Anniversaire")
  usedAt             DateTime?
  usedForReservation String? // ID de la r√©servation o√π la r√©duction a √©t√© utilis√©e
  expiresAt          DateTime? // Date d'expiration
  postponedFrom      String? // ID de la r√©duction d'origine si report√©e
  postponedTo        DateTime? // Date jusqu'√† laquelle c'est report√©
  postponedReason    String? // Raison du report
  notes              String? // Notes additionnelles
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  user               User         @relation(fields: [userId], references: [id])

  @@index([organizationId])
}

model PromoCode {
  id             String    @id @default(cuid())
  organizationId String? // Organisation (multi-tenant)
  code           String    @unique
  discount       Float // Montant de la r√©duction
  type           String // birthday, referral, special, percentage, fixed
  validFrom      DateTime  @default(now())
  validUntil     DateTime?
  maxUses        Int? // Nombre max d'utilisations
  usedCount      Int       @default(0)
  userId         String? // Si le code est sp√©cifique √† un utilisateur
  conditions     String? // Conditions d'utilisation (JSON)
  active         Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([organizationId])
  @@index([code])
}

model EmailAutomation {
  id         String    @id @default(cuid())
  name       String
  trigger    String // birthday, appointment_reminder, review_request, etc.
  template   String // EmailJS template ID
  enabled    Boolean   @default(true)
  timing     String? // JSON avec les infos de timing
  conditions String? // JSON avec les conditions
  lastRun    DateTime?
  nextRun    DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model GoogleReview {
  id             String       @id @default(cuid())
  organizationId String // Lien vers l'organisation
  authorName     String
  authorPhoto    String?
  rating         Int
  comment        String
  reviewId       String       @unique // ID Google pour √©viter les doublons
  publishedAt    DateTime
  replyText      String?
  replyAt        DateTime?
  helpful        Int          @default(0)
  language       String       @default("fr")
  syncedAt       DateTime     @default(now())
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, publishedAt])
}

model BusinessStats {
  id                  String    @id @default(cuid())
  googleRating        Float     @default(0)
  googleReviewCount   Int       @default(0)
  internalRating      Float     @default(0)
  internalReviewCount Int       @default(0)
  lastGoogleSync      DateTime?
  googlePlaceId       String?
  googleBusinessUrl   String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

model NewsletterSubscriber {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String       @unique
  name           String?
  isActive       Boolean      @default(true)
  subscribedAt   DateTime     @default(now())
  unsubscribedAt DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
}

model WhatsAppHistory {
  id           String    @id @default(cuid())
  from         String // Num√©ro de t√©l√©phone de l'exp√©diteur
  to           String // Num√©ro de t√©l√©phone du destinataire
  message      String // Contenu du message
  status       String    @default("sent") // sent, delivered, read, failed
  direction    String    @default("outgoing") // outgoing, incoming
  userId       String? // Client associ√©
  mediaUrl     String? // URL des m√©dias attach√©s
  errorMessage String?
  deliveredAt  DateTime?
  readAt       DateTime?
  createdAt    DateTime  @default(now())
}

model WhatsAppTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  category    String // reminder, promotion, birthday, followup, custom
  content     String // Template avec variables {name}, {time}, etc.
  variables   String // JSON array des variables utilis√©es
  usage       Int      @default(0)
  successRate Float    @default(100)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model WhatsAppAutomation {
  id           String    @id @default(cuid())
  name         String
  trigger      String // appointment_24h, appointment_48h, birthday, post_service, review_request
  templateId   String // R√©f√©rence au template
  enabled      Boolean   @default(true)
  timing       String? // JSON avec les infos de timing (heures avant/apr√®s, heure d'envoi, etc.)
  conditions   String? // JSON avec les conditions d'envoi
  lastRun      DateTime?
  nextRun      DateTime?
  messagesSent Int       @default(0)
  successCount Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model WhatsAppCampaign {
  id             String    @id @default(cuid())
  name           String
  templateId     String // R√©f√©rence au template
  recipients     String // JSON array des num√©ros ou tags
  recipientCount Int       @default(0)
  status         String    @default("draft") // draft, scheduled, active, paused, completed, cancelled
  scheduledAt    DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  sentCount      Int       @default(0)
  deliveredCount Int       @default(0)
  readCount      Int       @default(0)
  failedCount    Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model CommunicationHistory {
  id        String   @id @default(cuid())
  userId    String // Client associ√©
  type      String // email, whatsapp, sms, call
  direction String // incoming, outgoing
  subject   String? // Pour les emails
  content   String // Contenu du message
  status    String   @default("sent") // sent, delivered, read, failed
  metadata  String? // JSON avec m√©tadonn√©es suppl√©mentaires
  createdAt DateTime @default(now())
}

model Product {
  id               String           @id @default(cuid())
  organizationId   String
  slug             String           @default("")
  name             String
  description      String
  shortDescription String?
  metaTitle        String?
  metaDescription  String?
  keywords         String?
  price            Float
  salePrice        Float?
  category         String?
  categoryId       String?
  productCategory  ProductCategory? @relation(fields: [categoryId], references: [id])
  brand            String?
  mainImage        String?
  imageSettings    String? // JSON pour objectFit, position, zoom
  gallery          String? // JSON array d'URLs d'images
  ingredients      String?
  usage            String?
  benefits         String?
  active           Boolean          @default(true)
  featured         Boolean          @default(false)
  order            Int              @default(0)

  // Template tracking (LAIA Connect)
  templateSourceId String? // ID du produit template d'origine
  isCustomized     Boolean @default(false) // true si modifi√© par le client

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([active])
}

model ProductCategory {
  id        String    @id @default(cuid())
  name      String
  slug      String    @unique
  active    Boolean   @default(true)
  order     Int       @default(0)
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Stock {
  id              String       @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name            String
  description     String?
  category        String? // Consommables, Mat√©riel, Produits de soin, etc.
  quantity        Int          @default(0)
  initialQuantity Int? // Quantit√© initiale pour afficher "X sur Y"
  minQuantity     Int          @default(5) // Seuil d'alerte
  unit            String? // ml, g, pi√®ce, etc.
  cost            Float? // Prix d'achat
  supplier        String?
  purchaseUrl     String? // URL pour racheter le produit
  reference       String?
  barcode         String?
  expiryDate      DateTime?
  lastRestocked   DateTime?
  location        String? // Emplacement dans le stock
  notes           String?
  active          Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  serviceLinks ServiceStock[] // Relation avec les services
  movements    StockMovement[] // Historique des mouvements

  @@index([category])
  @@index([organizationId])
}

// Table de liaison entre Services et Stock (Many-to-Many)
model ServiceStock {
  id             String   @id @default(cuid())
  serviceId      String
  stockId        String
  quantityPerUse Float    @default(1) // Quantit√© consomm√©e par prestation (ex: 5ml, 10g, etc.)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  stock   Stock   @relation(fields: [stockId], references: [id], onDelete: Cascade)

  @@unique([serviceId, stockId])
  @@index([serviceId])
  @@index([stockId])
}

// Historique des mouvements de stock
model StockMovement {
  id            String   @id @default(cuid())
  stockId       String
  type          String // "IN" (ajout), "OUT" (utilisation), "ADJUSTMENT" (ajustement manuel)
  quantity      Float // Quantit√© (positive ou n√©gative)
  reason        String? // Raison du mouvement
  reservationId String? // Si li√© √† une r√©servation
  userId        String? // Qui a effectu√© l'action
  createdAt     DateTime @default(now())

  stock       Stock        @relation(fields: [stockId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  user        User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([stockId])
  @@index([reservationId])
  @@index([createdAt])
}

model Formation {
  id               String  @id @default(cuid())
  slug             String  @unique @default("")
  name             String
  shortDescription String  @default("")
  description      String
  metaTitle        String?
  metaDescription  String?
  keywords         String?
  price            Float
  promoPrice       Float?
  duration         Int // Dur√©e en heures
  level            String? // D√©butant, Interm√©diaire, Avanc√©
  program          String? // JSON - Programme d√©taill√© de la formation
  objectives       String? // JSON - Objectifs p√©dagogiques
  prerequisites    String? // Pr√©requis
  certification    String? // Type de certification d√©livr√©e
  maxParticipants  Int? // Nombre max de participants
  mainImage        String?
  imageSettings    String? // JSON pour objectFit, position, zoom
  gallery          String? // JSON
  videoUrl         String?
  category         String?
  instructor       String? // Nom du formateur
  active           Boolean @default(true)
  featured         Boolean @default(false)
  order            Int     @default(0)

  // Template tracking (LAIA Connect)
  templateSourceId String? // ID de la formation template d'origine
  isCustomized     Boolean @default(false) // true si modifi√© par le client
  organizationId   String // Organisation propri√©taire - OBLIGATOIRE (multi-tenant)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
}

model Order {
  id              String  @id @default(cuid())
  orderNumber     String  @unique // Num√©ro de commande unique (ex: ORD-2024-00001)
  organizationId  String // Organisation - OBLIGATOIRE (multi-tenant)
  userId          String? // Peut √™tre null pour commandes invit√©s
  customerName    String
  customerEmail   String
  customerPhone   String?
  customerAddress String? // JSON avec adresse compl√®te

  orderType String // "product" ou "formation"
  items     String // JSON array des articles command√©s [{id, name, quantity, price}]

  subtotal     Float // Sous-total
  shippingCost Float @default(0)
  discount     Float @default(0)
  totalAmount  Float // Montant total

  paymentStatus String    @default("pending") // pending, paid, failed, refunded
  paymentMethod String? // card, transfer, cash, stripe
  paymentDate   DateTime?
  transactionId String? // ID de transaction Stripe/autre

  status         String  @default("pending") // pending, confirmed, processing, shipped, delivered, cancelled
  shippingStatus String? // pending, shipped, delivered
  trackingNumber String?

  scheduledDate DateTime? // Date pr√©vue de retrait/livraison/formation
  scheduledTime String? // Heure pr√©vue (format HH:mm)

  notes      String? // Notes client
  adminNotes String? // Notes internes admin

  invoiceUrl String? // URL de la facture g√©n√©r√©e

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User?    @relation(fields: [userId], references: [id])
  reviews Review[]

  @@index([userId])
  @@index([organizationId])
  @@index([orderNumber])
  @@index([paymentStatus])
  @@index([status])
}

model MagicLink {
  id        String   @id @default(cuid())
  token     String   @unique
  email     String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([email])
}

model GiftCard {
  id             String    @id @default(cuid())
  organizationId String? // Organisation (multi-tenant)
  code           String    @unique // Code unique de la carte cadeau (ex: GIFT-XXXX-XXXX)
  amount         Float // Montant de la carte cadeau
  initialAmount  Float // Montant initial (pour historique)
  balance        Float // Solde restant
  purchasedBy    String? // ID de l'utilisateur qui a achet√©
  purchasedFor   String? // Nom du b√©n√©ficiaire si cadeau
  recipientEmail String? // Email du b√©n√©ficiaire
  recipientPhone String? // T√©l√©phone du b√©n√©ficiaire
  message        String? // Message personnalis√©
  status         String    @default("active") // active, used, expired, cancelled
  purchaseDate   DateTime  @default(now())
  expiryDate     DateTime? // Date d'expiration (optionnelle)
  usedDate       DateTime? // Date d'utilisation compl√®te
  createdBy      String? // ID admin qui a cr√©√© (si cr√©ation manuelle)
  notes          String? // Notes admin
  paymentMethod  String? // Mode de paiement (CB, esp√®ces, ch√®que, etc.)
  paymentStatus  String    @default("paid") // paid, pending
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization? @relation("OrganizationGiftCards", fields: [organizationId], references: [id])
  purchaser    User?         @relation("GiftCardPurchaser", fields: [purchasedBy], references: [id])
  reservations Reservation[] @relation("GiftCardReservations") // R√©servations faites avec cette carte

  @@index([organizationId])
  @@index([code])
  @@index([purchasedBy])
  @@index([status])
}

model GiftCardSettings {
  id                       String   @id @default(cuid())
  emailSubject             String   @default("Vous avez re√ßu une carte cadeau Laia Skin Institut !")
  emailTitle               String   @default("üéÅ Vous avez re√ßu une Carte Cadeau !")
  emailIntro               String   @default("Quelle belle attention ! Vous venez de recevoir une carte cadeau pour d√©couvrir ou red√©couvrir les soins d'exception de Laia Skin Institut.") @db.Text
  emailInstructions        String   @default("Utilisez le code ci-dessous lors de votre r√©servation en ligne ou contactez-nous pour prendre rendez-vous.") @db.Text
  emailFooter              String   @default("Cette carte cadeau est valable 1 an √† partir de la date d'√©mission.") @db.Text
  physicalCardTitle        String   @default("CARTE CADEAU")
  physicalCardSubtitle     String   @default("Laia Skin Institut")
  physicalCardValidity     String   @default("Valable 1 an")
  physicalCardInstructions String   @default("Pr√©sentez cette carte lors de votre visite ou utilisez le code en ligne.") @db.Text
  cardColorFrom            String   @default("#ec4899") // Couleur gradient d√©but (rose par d√©faut)
  cardColorTo              String   @default("#be185d") // Couleur gradient fin (rose fonc√© par d√©faut)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@map("gift_card_settings")
}

model EmailTemplate {
  id                 String   @id @default(cuid())
  slug               String // Identifiant unique (ex: "onboarding-welcome", "payment-confirmation")
  name               String // Nom du template (ex: "Email de bienvenue onboarding")
  description        String?  @db.Text // Description du template pour documentation
  subject            String // Sujet de l'email
  content            String   @db.Text // Contenu HTML de l'email
  textContent        String?  @db.Text // Version texte brut (fallback)
  availableVariables Json? // Liste des variables disponibles (ex: {firstName, organizationName, ...})
  category           String?  @default("general") // general, onboarding, promo, rappel, transactionnel
  isActive           Boolean  @default(true)
  isSystem           Boolean  @default(false) // Templates syst√®me non modifiables/supprimables
  fromName           String? // Nom exp√©diteur (override si besoin)
  fromEmail          String? // Email exp√©diteur (override si besoin)
  language           String   @default("fr") // Langue du template (fr, en, es, ...)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Multi-tenant: isolation par organisation (null = template global LAIA Connect)
  organizationId String? // Organization (nullable for global templates)
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([slug, organizationId]) // Un slug unique par organisation
  @@index([category])
  @@index([isActive])
  @@index([isSystem])
  @@map("email_templates")
}

model SocialMediaPost {
  id             String    @id @default(cuid())
  userId         String? // Propri√©taire du post
  socialConfigId String? // Compte social media utilis√©
  title          String // Titre/sujet de la publication
  content        String    @db.Text // Texte de la publication
  platform       String? // Instagram, Facebook, TikTok, etc.
  scheduledDate  DateTime // Date de publication pr√©vue
  status         String    @default("draft") // draft, scheduled, published, cancelled
  notes          String?   @db.Text // Notes et id√©es suppl√©mentaires
  links          String?   @db.Text // JSON array de liens utiles
  hashtags       String? // Hashtags √† utiliser
  mediaUrls      String?   @db.Text // JSON array d'URLs des m√©dias (images/vid√©os)
  publishedAt    DateTime? // Date de publication effective
  apiPostId      String? // ID de la publication sur la plateforme
  errorMessage   String?   @db.Text // Message d'erreur en cas d'√©chec
  instagramType  String? // post, story, reel
  facebookType   String? // post, story, reel
  tiktokType     String? // reel
  category       String? // conseils, avant-apres, nouveaute, promotion, etc.
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([userId])
  @@index([scheduledDate])
  @@index([status])
  @@index([category])
}

model SocialMediaConfig {
  id           String    @id @default(cuid())
  userId       String? // Propri√©taire du compte (null = compte global)
  platform     String // instagram, facebook, tiktok, youtube
  accountName  String? // Nom du compte/page pour affichage
  accessToken  String?   @db.Text // Token d'acc√®s
  refreshToken String?   @db.Text // Token de rafra√Æchissement
  pageId       String? // ID de la page/compte
  accountId    String? // ID du compte Instagram/Facebook
  appId        String? // App ID Meta
  appSecret    String?   @db.Text // App Secret Meta
  expiresAt    DateTime? // Date d'expiration du token
  enabled      Boolean   @default(false)
  autoPublish  Boolean   @default(false) // Publication automatique activ√©e
  isDefault    Boolean   @default(false) // Compte par d√©faut pour ce user
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([userId, platform, accountId]) // Un user peut avoir plusieurs comptes par plateforme
  @@index([userId])
  @@index([platform])
}

model WhatsAppConfig {
  id                 String    @id @default(cuid())
  userId             String? // Propri√©taire du compte (null = compte global)
  accountName        String? // Nom du compte pour affichage
  phoneNumberId      String? // ID du num√©ro de t√©l√©phone WhatsApp Business
  phoneNumber        String? // Num√©ro de t√©l√©phone format√©
  accessToken        String?   @db.Text // Token d'acc√®s WhatsApp Business API
  businessAccountId  String? // ID du compte WhatsApp Business
  appId              String? // App ID Meta
  appSecret          String?   @db.Text // App Secret Meta
  webhookVerifyToken String? // Token de v√©rification webhook
  expiresAt          DateTime? // Date d'expiration du token
  enabled            Boolean   @default(false)
  isDefault          Boolean   @default(false) // Compte par d√©faut pour ce user
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@unique([userId, phoneNumberId])
  @@index([userId])
}

model EmailConfig {
  id          String   @id @default(cuid())
  userId      String? // Propri√©taire du compte (null = compte global)
  accountName String? // Nom du compte pour affichage (ex: "Contact Laia Skin")
  provider    String // resend, gmail, outlook, etc.
  email       String // Adresse email
  apiKey      String?  @db.Text // API Key (pour Resend, SendGrid, etc.)
  password    String?  @db.Text // Mot de passe (pour SMTP)
  smtpHost    String? // Serveur SMTP
  smtpPort    Int? // Port SMTP
  imapHost    String? // Serveur IMAP pour r√©ception
  imapPort    Int? // Port IMAP
  enabled     Boolean  @default(false)
  isDefault   Boolean  @default(false) // Compte par d√©faut pour ce user
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, email])
  @@index([userId])
}

model Integration {
  id      String  @id @default(cuid())
  userId  String? // Propri√©taire (null = config globale)
  type    String // 'stripe', 'google_calendar', 'paypal', 'twilio', etc.
  enabled Boolean @default(false)

  // Configuration chiffr√©e (JSON contenant les cl√©s API, tokens, etc.)
  config Json @default("{}")

  // Statut de la connexion
  status       String    @default("disconnected") // disconnected, connected, error, expired
  lastSync     DateTime?
  errorMessage String?   @db.Text

  // M√©tadonn√©es
  displayName String? // Nom affich√© dans l'interface
  description String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, type])
  @@index([userId])
  @@index([type])
  @@index([enabled])
}

// Cat√©gories de services (ex: Soins du visage, Soins du corps, √âpilation)
model ServiceCategory {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String // Ex: "Soins du visage"
  slug           String       @unique // Ex: "soins-visage"
  description    String?      @db.Text
  icon           String? // Ex: "FaFaceSmile" (nom de l'ic√¥ne React Icons)
  color          String       @default("#e11d48") // Couleur hex pour l'interface
  image          String? // Image de banni√®re de la cat√©gorie
  order          Int          @default(0) // Ordre d'affichage
  active         Boolean      @default(true)
  featured       Boolean      @default(false) // Mettre en avant sur la page d'accueil

  // SEO
  metaTitle       String?
  metaDescription String?
  keywords        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subcategories ServiceSubcategory[]
  services      Service[]            @relation("ServiceToCategory")

  @@index([slug])
  @@index([active])
  @@index([order])
  @@index([organizationId])
}

// Sous-cat√©gories de services (ex: sous "Soins du visage" ‚Üí HydroFacial, BB Glow)
model ServiceSubcategory {
  id             String          @id @default(cuid())
  organizationId String
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  categoryId     String
  name           String // Ex: "Soins anti-√¢ge"
  slug           String          @unique // Ex: "soins-anti-age"
  description    String?         @db.Text
  icon           String? // Ic√¥ne sp√©cifique
  image          String? // Image de la sous-cat√©gorie
  order          Int             @default(0)
  active         Boolean         @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  category ServiceCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  services Service[]       @relation("ServiceToSubcategory")

  @@index([categoryId])
  @@index([slug])
  @@index([active])
  @@index([order])
  @@index([organizationId])
}

// Historique des paiements (tous types confondus)
model Payment {
  id             String       @id @default(cuid())
  type           String // "reservation", "order", "giftcard"
  reservationId  String?
  orderId        String?
  giftCardId     String?
  userId         String
  organizationId String // OBLIGATOIRE - Organisation qui re√ßoit le paiement
  organization   Organization @relation(fields: [organizationId], references: [id])
  amount         Float
  currency       String       @default("eur")
  status         String // "pending", "succeeded", "failed", "refunded"
  paymentMethod  String // "stripe", "cash", "transfer", "check"

  // Stripe specific
  stripePaymentId  String? @unique // payment_intent_xxx
  stripeSessionId  String? // checkout_session_xxx
  stripeCustomerId String?
  stripeChargeId   String?
  stripeFees       Float? // Frais Stripe

  // M√©tadonn√©es
  description   String?
  metadata      String? // JSON pour infos suppl√©mentaires
  receiptUrl    String? // URL du re√ßu Stripe
  invoiceNumber String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([organizationId])
  @@index([reservationId])
  @@index([orderId])
  @@index([status])
  @@index([paymentMethod])
  @@index([stripePaymentId])
  @@index([createdAt])
}

// ============================================
// SUPER ADMIN MODELS
// ============================================

enum NotificationType {
  TRIAL_EXPIRING_7D // Essai expire dans 7 jours
  TRIAL_EXPIRING_3D // Essai expire dans 3 jours
  TRIAL_EXPIRED // Essai expir√©
  LIMIT_REACHED_80 // 80% de la limite atteinte
  LIMIT_REACHED_100 // 100% de la limite atteinte
  PAYMENT_FAILED // Paiement √©chou√©
  INACTIVE_ORG // Organisation inactive
  NEW_ORGANIZATION // Nouvelle organisation cr√©√©e
  CANCELLED_SUBSCRIPTION // Abonnement annul√©
}

model SuperAdminNotification {
  id             String           @id @default(cuid())
  type           NotificationType
  title          String
  message        String           @db.Text
  organizationId String // OBLIGATOIRE
  userId         String?
  read           Boolean          @default(false)
  actionUrl      String?
  metadata       Json? // Donn√©es additionnelles
  createdAt      DateTime         @default(now())

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([read])
  @@index([type])
  @@index([organizationId])
  @@index([createdAt])
}

enum AuditAction {
  CREATE_ORG
  UPDATE_ORG
  DELETE_ORG
  SUSPEND_ORG
  ACTIVATE_ORG
  CANCEL_ORG
  CHANGE_PLAN
  CREATE_USER
  UPDATE_USER
  DELETE_USER
  IMPERSONATE
  END_IMPERSONATE
  CREATE_LOCATION
  UPDATE_LOCATION
  DELETE_LOCATION
  UPDATE_SETTINGS
  RESET_PASSWORD
  DATA_EXPORT
}

model AuditLog {
  id             String      @id @default(cuid())
  userId         String // Super admin qui a fait l'action
  action         AuditAction
  targetType     String // ORGANIZATION, USER, LOCATION, etc.
  targetId       String?
  organizationId String // OBLIGATOIRE
  before         Json? // √âtat avant (pour updates)
  after          Json? // √âtat apr√®s (pour updates)
  ipAddress      String?
  userAgent      String?
  metadata       Json? // Donn√©es additionnelles
  createdAt      DateTime    @default(now())

  user         User          @relation(fields: [userId], references: [id])
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([targetType])
  @@index([organizationId])
  @@index([createdAt])
}

enum InvoiceStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  CANCELLED
  REPLACED
  OVERDUE
}

enum PaymentMethod {
  STRIPE
  MANUAL
  BANK_TRANSFER
  PAYPAL
}

model Invoice {
  id                    String        @id @default(cuid())
  organizationId        String
  invoiceNumber         String        @unique // LAIA-2025-001234
  amount                Float
  currency              String        @default("EUR")
  plan                  String? // SOLO, DUO, TEAM, PREMIUM
  status                InvoiceStatus @default(PENDING)
  stripeInvoiceId       String?       @unique
  stripePaymentIntentId String? // ID du PaymentIntent Stripe
  paidAt                DateTime?
  issueDate             DateTime      @default(now()) // Date d'√©mission
  dueDate               DateTime
  description           String?
  pdfPath               String? // Chemin vers le PDF
  metadata              Json? // D√©tails additionnels
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payments     BillingPayment[]

  @@index([organizationId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([dueDate])
  @@index([createdAt])
}

model BillingPayment {
  id              String        @id @default(cuid())
  invoiceId       String
  amount          Float
  method          PaymentMethod
  stripePaymentId String?       @unique
  status          InvoiceStatus
  metadata        Json? // D√©tails additionnels
  createdAt       DateTime      @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([status])
  @@index([createdAt])
}

// Configuration des factures LAIA (param√®tres globaux)
model InvoiceSettings {
  id String @id @default(cuid())

  // Statut juridique
  isCompany   Boolean @default(false) // false = auto-entrepreneur, true = soci√©t√©
  legalStatus String  @default("Auto-Entrepreneur") // "Auto-Entrepreneur", "SAS", "SARL", "SASU", etc.

  // Informations √©metteur (LAIA)
  companyName   String  @default("LAIA Connect")
  address       String  @default("[Votre adresse]")
  postalCode    String  @default("[Code postal]")
  city          String  @default("[Ville]")
  country       String  @default("France")
  siret         String  @default("[Votre SIRET]")
  tvaNumber     String? @default("") // Vide si auto-entrepreneur en franchise
  capitalSocial String? @default("") // Vide si auto-entrepreneur
  rcs           String? @default("") // Vide si auto-entrepreneur
  apeCode       String  @default("6201Z") // Code APE/NAF

  // Contact
  email   String  @default("[Votre email]")
  phone   String? @default("[Votre t√©l√©phone]")
  website String? @default("https://www.laia-connect.fr")

  // Design
  logoUrl        String? // URL du logo
  primaryColor   String  @default("#667eea") // Violet
  secondaryColor String  @default("#764ba2") // Rose

  // Param√®tres facture
  invoicePrefix String @default("LAIA") // LAIA-2025-001234
  tvaRate       Float  @default(0.0) // 0 pour auto-entrepreneur, 20 pour soci√©t√©

  // Mentions l√©gales
  paymentTerms String  @default("Pr√©l√®vement SEPA automatique")
  latePenalty  String  @default("En cas de retard de paiement, indemnit√© forfaitaire de 40‚Ç¨ pour frais de recouvrement.")
  footerText   String? @default("Dispens√© d'immatriculation au RCS et au RM")

  // Templates de contrat (articles modifiables)
  contractArticle1 String @default("Le pr√©sent contrat a pour objet de d√©finir les conditions dans lesquelles le Prestataire met √† disposition du Client sa solution SaaS LAIA Connect, comprenant un site web personnalisable, un syst√®me de r√©servation en ligne, et diverses fonctionnalit√©s de gestion pour instituts de beaut√©.") @db.Text
  contractArticle3 String @default("Le Client b√©n√©ficie d'une p√©riode d'essai gratuite de 30 jours √† compter de la date de souscription. Le premier pr√©l√®vement interviendra √† l'issue de cette p√©riode.") @db.Text
  contractArticle4 String @default("Le contrat est conclu pour une dur√©e ind√©termin√©e. Il se renouvelle automatiquement chaque mois par tacite reconduction. Le Client peut r√©silier √† tout moment avec un pr√©avis de 30 jours.") @db.Text
  contractArticle6 String @default("Le pr√©sent contrat est r√©gi par les Conditions G√©n√©rales de Vente (CGV) de LAIA Connect, accessibles en ligne √† l'adresse : https://www.laiaconnect.fr/cgv-laia-connect\n\nLe Client d√©clare avoir pris connaissance des CGV et les accepter sans r√©serve.") @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Mod√®le pour les clauses de contrat (syst√®me modulaire et personnalisable)
model ContractClause {
  id        String   @id @default(cuid())
  key       String   @unique // article_1, article_2, etc.
  title     String // "ARTICLE 1 - OBJET DU CONTRAT"
  content   String   @db.Text // Contenu de l'article (supporte {variables})
  order     Int      @default(0) // Ordre d'affichage dans le contrat
  isDefault Boolean  @default(true) // Clause par d√©faut ou personnalis√©e
  isActive  Boolean  @default(true) // Afficher dans le contrat ou non
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([order])
  @@index([isActive])
}

enum SuperAdminEmailKey {
  WELCOME
  TRIAL_ENDING_7D
  TRIAL_ENDING_3D
  TRIAL_EXPIRED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  LIMIT_REACHED
  NEWSLETTER
  PASSWORD_RESET
}

model SuperAdminEmailTemplate {
  id        String             @id @default(cuid())
  key       SuperAdminEmailKey @unique
  name      String
  subject   String
  htmlBody  String             @db.Text
  textBody  String?            @db.Text
  variables Json // Liste des variables disponibles
  active    Boolean            @default(true)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@index([key])
  @@index([active])
}

model PlatformConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  updatedBy   String // User ID du super admin

  @@index([key])
}

// ============================================
// API TOKEN MANAGEMENT (S√©curit√©)
// ============================================

// Stockage s√©curis√© des tokens API (chiffr√©s)
model ApiToken {
  id String @id @default(cuid())

  // Multi-tenant: chaque organisation a ses propres tokens
  organizationId String // OBLIGATOIRE
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  service        String // WHATSAPP, INSTAGRAM, FACEBOOK, STRIPE, RESEND, SNAPCHAT, TIKTOK, LINKEDIN, TWITTER
  name           String // access_token, secret_key, page_id, account_id, etc.
  encryptedToken String    @db.Text
  expiresAt      DateTime?
  metadata       Json? // Pour stocker des infos suppl√©mentaires (account_id, page_id, etc.)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Unique par organisation + service + name (ou global si organizationId = null)
  @@unique([organizationId, service, name])
  @@map("api_tokens")
}

// ============================================
// SUPER ADMIN - SUPPORT
// ============================================

// Tickets de support
enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CUSTOMER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketCategory {
  TECHNICAL // Probl√®me technique
  BILLING // Facturation
  FEATURE_REQUEST // Demande de fonctionnalit√©
  QUESTION // Question
  BUG // Bug
  OTHER // Autre
}

model SupportTicket {
  id             String         @id @default(cuid())
  ticketNumber   String         @unique // #TICKET-001
  subject        String
  description    String         @db.Text
  status         TicketStatus   @default(OPEN)
  priority       TicketPriority @default(MEDIUM)
  category       TicketCategory
  organizationId String
  createdById    String // User qui a cr√©√© le ticket
  assignedToId   String? // Super admin assign√©
  resolvedAt     DateTime?
  closedAt       DateTime?

  // SLA Tracking
  firstResponseAt       DateTime? // Timestamp de la premi√®re r√©ponse
  slaResponseDeadline   DateTime? // Deadline pour la premi√®re r√©ponse (calcul√© selon la priorit√©)
  slaResponseBreach     Boolean   @default(false) // Violation du SLA de r√©ponse
  slaResolutionDeadline DateTime? // Deadline pour la r√©solution (calcul√© selon la priorit√©)
  slaResolutionBreach   Boolean   @default(false) // Violation du SLA de r√©solution

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User            @relation("TicketCreator", fields: [createdById], references: [id])
  assignedTo   User?           @relation("TicketAssignee", fields: [assignedToId], references: [id])
  messages     TicketMessage[]

  @@index([ticketNumber])
  @@index([status])
  @@index([priority])
  @@index([organizationId])
  @@index([assignedToId])
  @@index([createdAt])
  @@index([slaResponseBreach])
  @@index([slaResolutionBreach])
}

model TicketMessage {
  id          String   @id @default(cuid())
  ticketId    String
  authorId    String
  message     String   @db.Text
  attachments Json? // URLs des fichiers
  isInternal  Boolean  @default(false) // Note interne (non visible par le client)
  createdAt   DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author User          @relation(fields: [authorId], references: [id])

  @@index([ticketId])
  @@index([createdAt])
}

// ============================================
// PRIORIT√â 2 - SUPER ADMIN FEATURES
// ============================================

// Codes promo pour les abonnements LAIA
enum SubscriptionPromoType {
  PERCENTAGE // R√©duction en pourcentage
  FIXED // Montant fixe
  FREE_TRIAL // Essai gratuit prolong√©
}

enum SubscriptionPromoStatus {
  ACTIVE // Actif
  EXPIRED // Expir√©
  DISABLED // D√©sactiv√©
}

model SubscriptionPromoCode {
  id          String                @id @default(cuid())
  code        String                @unique // "LAIA2025"
  description String? // "Promotion lancement 2025"
  type        SubscriptionPromoType
  value       Float // 20 (pour 20%) ou 50 (pour 50‚Ç¨)

  // Applicabilit√©
  targetPlans String[] // ["SOLO", "DUO"] ou [] pour tous
  maxUses     Int? // Nombre max d'utilisations (null = illimit√©)
  currentUses Int      @default(0)

  // Dates de validit√©
  validFrom  DateTime  @default(now())
  validUntil DateTime?

  status SubscriptionPromoStatus @default(ACTIVE)

  // Utilisation
  usedBy Organization[] @relation("SubscriptionPromoUsage")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([status])
  @@index([validFrom])
  @@index([validUntil])
}

// T√©moignages clients pour le marketing
enum TestimonialStatus {
  PENDING // En attente d'approbation
  APPROVED // Approuv√© et visible
  REJECTED // Rejet√©
}

model Testimonial {
  id String @id @default(cuid())

  // Client
  clientName     String // "Marie Dupont"
  clientRole     String? // "G√©rante, Beaut√© √âternelle Paris"
  clientPhoto    String? // URL de la photo
  organizationId String // Lien vers l'organisation (optionnel)

  // Contenu
  content String @db.Text
  rating  Int    @default(5) // 1-5 √©toiles

  // M√©tadonn√©es
  status        TestimonialStatus @default(PENDING)
  featured      Boolean           @default(false) // Mis en avant
  showOnLanding Boolean           @default(false) // Afficher sur la page d'accueil

  // Tags pour filtrer
  tags String[] // ["onboarding", "support", "features"]

  organization Organization? @relation("OrganizationTestimonials", fields: [organizationId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([featured])
  @@index([showOnLanding])
  @@index([organizationId])
}

// Notifications push pour les organisations
enum PushNotificationStatus {
  SCHEDULED // Programm√©e
  SENT // Envoy√©e
  FAILED // √âchec
}

model PushNotification {
  id    String  @id @default(cuid())
  title String
  body  String  @db.Text
  icon  String?
  url   String? // URL de redirection au clic

  // Ciblage
  targetAll   Boolean  @default(false)
  targetPlans String[] // ["SOLO", "DUO"]
  targetOrgs  String[] // IDs des organisations cibl√©es

  // Programmation
  scheduledAt DateTime?
  sentAt      DateTime?
  status      PushNotificationStatus @default(SCHEDULED)

  // Statistiques
  totalSent    Int @default(0)
  totalClicked Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([scheduledAt])
  @@index([sentAt])
}

// ============================================
// CRM & PROSPECTION MODELS
// ============================================

enum LeadStatus {
  NEW // Nouveau lead (d√©couverte)
  CONTACTED // Premier contact effectu√©
  QUALIFIED // Prospect qualifi√© (int√©ress√©)
  DEMO_SCHEDULED // D√©mo planifi√©e
  DEMO_DONE // D√©mo effectu√©e
  PROPOSAL_SENT // Proposition commerciale envoy√©e
  NEGOTIATION // En n√©gociation
  WON // Gagn√© ‚Üí converti en client
  LOST // Perdu
  ON_HOLD // En attente
}

enum LeadQualification {
  COLD // Lead froid - peu d'int√©r√™t
  WARM // Lead moyen - int√©ress√© mais pas press√©
  HOT // Lead chaud - tr√®s int√©ress√©, pr√™t √† acheter
}

enum InteractionType {
  EMAIL
  PHONE
  MEETING
  DEMO
  WHATSAPP
  LINKEDIN_MESSAGE
  NOTE
}

model Lead {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations institut
  institutName String
  contactName  String
  contactEmail String
  contactPhone String?
  website      String?
  address      String?
  city         String?
  postalCode   String?
  country      String  @default("France")

  // Informations business
  numberOfLocations Int      @default(1)
  numberOfEmployees Int?
  currentSoftware   String? // Logiciel actuel utilis√©
  estimatedRevenue  Decimal? @db.Decimal(10, 2)
  painPoints        String[] // Points de douleur

  // Pipeline
  status         LeadStatus         @default(NEW)
  qualification  LeadQualification? // Qualification du lead (froid/moyen/chaud)
  source         LeadSource
  score          Int                @default(0) // Score de qualit√© 0-100
  probability    Int                @default(0) // Probabilit√© de conversion 0-100%
  estimatedValue Decimal?           @db.Decimal(10, 2)

  // Suivi commercial
  assignedToUserId  String?
  assignedTo        User?     @relation(fields: [assignedToUserId], references: [id])
  nextFollowUpDate  DateTime?
  lastContactDate   DateTime?
  expectedCloseDate DateTime?

  // Conversion
  organizationId String? // null pour leads SaaS LAIA, sinon organization cliente
  organization   Organization? @relation(fields: [organizationId], references: [id])
  convertedAt    DateTime?
  lostReason     String?

  // M√©tadonn√©es
  tags  String[]
  notes String?  @db.Text

  interactions  LeadInteraction[]
  demoBooking   DemoBooking?      @relation("DemoBookingLead")
  funnelEntries FunnelEntry[] // Progression dans les funnels

  @@index([status])
  @@index([assignedToUserId])
  @@index([source])
  @@index([nextFollowUpDate])
  @@index([contactEmail])
  @@index([city])
}

model LeadInteraction {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  type           InteractionType
  subject        String?
  content        String          @db.Text
  nextAction     String?
  nextActionDate DateTime?

  // Pi√®ces jointes
  attachments String[]

  @@index([leadId])
  @@index([userId])
  @@index([createdAt])
}

model ProspectingEmailTemplate {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name     String
  subject  String
  body     String  @db.Text // HTML avec variables {{institutName}}, {{contactName}}, etc.
  category String? // 'first_contact', 'follow_up', 'demo', 'proposal', etc.
  isActive Boolean @default(true)
}

// Syst√®me de calendrier pour les d√©mos commerciales
model DemoSlot {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  date     DateTime // Date et heure du cr√©neau
  duration Int      @default(30) // Dur√©e en minutes
  userId   String? // Commercial assign√© (super-admin)
  user     User?    @relation("DemoSlots", fields: [userId], references: [id])

  isAvailable Boolean @default(true)
  isRecurring Boolean @default(false) // Cr√©neau r√©current chaque semaine
  dayOfWeek   Int? // 0=Dimanche, 1=Lundi, etc. (pour r√©currence)

  bookings DemoBooking[]
}

model DemoBooking {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  slotId String
  slot   DemoSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)

  // Informations du prospect
  institutName String
  contactName  String
  contactEmail String
  contactPhone String?
  message      String? @db.Text

  // Lead associ√©
  leadId String? @unique
  lead   Lead?   @relation("DemoBookingLead", fields: [leadId], references: [id])

  // Origine du prospect
  leadSource LeadSource? @default(DEMO_FORM) // D'o√π vient ce prospect

  // Type de rendez-vous
  type     String  @default("ONLINE") // ONLINE (visio) ou PHYSICAL (physique)
  location String? // Adresse si rendez-vous physique

  // Dur√©e personnalis√©e (optionnelle, sinon prend la dur√©e du slot)
  customDuration Int? // Dur√©e en minutes

  status     String  @default("CONFIRMED") // CONFIRMED, COMPLETED, CANCELLED, NO_SHOW
  meetingUrl String? // URL visio si d√©mo en ligne
  notes      String? @db.Text

  reminderSent Boolean   @default(false)
  completedAt  DateTime?
  cancelledAt  DateTime?

  // Super-admin tracking
  viewedByAdminAt DateTime? // Date √† laquelle le super-admin a vu cette d√©mo
}

// ============================================
// PLATFORM NEWS - NOUVEAUT√âS LAIA BEAUTY
// ============================================

enum PlatformNewsStatus {
  DRAFT // Brouillon
  PUBLISHED // Publi√©
  ARCHIVED // Archiv√©
}

model PlatformNews {
  id       String             @id @default(cuid())
  title    String
  slug     String             @unique
  excerpt  String             @db.Text
  content  String             @db.Text
  category String // "Nouvelle fonctionnalit√©", "Mise √† jour", "Conseil", etc.
  status   PlatformNewsStatus @default(DRAFT)

  featuredImage String?
  tags          Json? // ["automatisation", "r√©servation", "IA"]

  // SEO
  seoTitle       String?
  seoDescription String?

  // Author (Super Admin)
  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([publishedAt])
  @@index([category])
  @@index([authorId])
}

// ============================================
// AI CONTENT ANALYSIS & SUGGESTIONS
// ============================================

// Analyse IA du feed social media
model ContentAnalysis {
  id             String @id @default(cuid())
  organizationId String // OBLIGATOIRE
  platform       String // "instagram", "facebook"

  // Analyse du feed
  toneOfVoice   String @db.Text // "friendly", "professional", "casual"
  topHashtags   Json // ["hashtag1", "hashtag2"...]
  avgEngagement Float
  bestPostTypes Json // ["reel", "carousel", "photo"]
  bestPostTimes Json // ["14:00", "18:00"]

  // Exemples de posts performants
  topPosts Json // [{content, likes, comments}...]

  analyzedAt DateTime @default(now())

  @@index([organizationId])
  @@index([platform])
  @@index([analyzedAt])
}

// Suggestions de contenu g√©n√©r√©es par IA
model AISuggestion {
  id             String @id @default(cuid())
  organizationId String // OBLIGATOIRE
  category       String // "conseils", "avant-apres", etc.
  contentType    String // "post", "story", "reel"

  title        String
  content      String  @db.Text
  hashtags     String?
  trendingNote String?

  generatedBy String   @default("openai-gpt4")
  createdAt   DateTime @default(now())

  @@index([organizationId, category])
  @@index([contentType])
  @@index([createdAt])
}

// ============================================
// ACTIVITY LOG (AUDIT TRAIL)
// ============================================

// Journal des activit√©s syst√®me et utilisateur
model ActivityLog {
  id          String   @id @default(cuid())
  userId      String // ID de l'utilisateur qui a effectu√© l'action (ou "system" pour les actions automatiques)
  action      String // Type d'action (PAYMENT_REMINDER_1, PAYMENT_REMINDER_2, ORGANIZATION_SUSPENDED, etc.)
  entityType  String // Type d'entit√© concern√©e (INVOICE, ORGANIZATION, USER, etc.)
  entityId    String // ID de l'entit√© concern√©e
  description String   @db.Text // Description de l'action
  metadata    Json? // Donn√©es suppl√©mentaires (montant, num√©ro de facture, etc.)
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
}

// ============================================
// WEBSITE TEMPLATES
// ============================================

// Templates de sites web pour les organisations
model WebsiteTemplate {
  id              String  @id @default(cuid())
  name            String // Nom du template (ex: "√âl√©gance Rose", "Minimaliste Zen")
  description     String  @db.Text // Description du template
  previewImageUrl String? // URL de l'image de pr√©visualisation

  // Configuration du template (couleurs, polices, layout, etc.)
  config Json // { colors: { primary, secondary, accent }, fonts: { heading, body }, layout: "classic" | "modern" }

  // Tier d'acc√®s
  minTier String @default("DUO") // Tier minimum requis: SOLO, DUO, TEAM, ENTERPRISE

  // M√©tadonn√©es
  category     String  @default("beauty") // beauty, spa, salon, barbershop, wellness
  isActive     Boolean @default(true)
  displayOrder Int     @default(0)

  // Relations
  organizations Organization[] @relation("OrganizationWebsiteTemplate")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([minTier])
  @@index([category])
  @@index([isActive, displayOrder])
}

// ============================================================================
// CRM: SEGMENTATION CLIENTS
// ============================================================================

model ClientSegment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name        String // "Clients VIP", "Inactifs 6 mois", etc.
  description String?
  color       String  @default("#3B82F6") // Couleur pour l'UI

  // Crit√®res de segmentation (JSON)
  criteria Json // {totalSpent: {min: 500}, lastVisit: {daysAgo: {max: 30}}, etc.}

  // Statistiques
  clientCount Int      @default(0)
  totalValue  Decimal? @db.Decimal(10, 2)

  // Automatisation
  isAutomatic Boolean @default(true) // Se met √† jour automatiquement
  isActive    Boolean @default(true)

  // Relations
  campaigns CampaignSegment[]

  @@index([organizationId])
  @@index([isActive])
}

model CampaignSegment {
  id String @id @default(cuid())

  campaignId String
  campaign   EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  segmentId String
  segment   ClientSegment @relation(fields: [segmentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([campaignId, segmentId])
  @@index([campaignId])
  @@index([segmentId])
}

// ============================================================================
// CRM: FUNNEL DE CONVERSION
// ============================================================================

enum FunnelStage {
  AWARENESS // Prise de conscience
  INTEREST // Int√©r√™t
  CONSIDERATION // Consid√©ration  
  INTENT // Intention
  EVALUATION // √âvaluation
  PURCHASE // Achat
}

model ConversionFunnel {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizationId String // OBLIGATOIRE
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name        String
  description String?

  // √âtapes du funnel
  stages Json // [{name: "Visite site", stage: "AWARENESS"}, ...]

  // Statistiques
  isActive Boolean @default(true)

  entries FunnelEntry[]

  @@index([organizationId])
  @@index([isActive])
}

model FunnelEntry {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  funnelId String
  funnel   ConversionFunnel @relation(fields: [funnelId], references: [id], onDelete: Cascade)

  // Lead ou Client
  leadId String?
  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // √âtape actuelle
  currentStage FunnelStage @default(AWARENESS)

  // Progression
  stages Json // [{stage: "AWARENESS", enteredAt: "...", exitedAt: "..."}]

  // Conversion
  isConverted     Boolean   @default(false)
  convertedAt     DateTime?
  conversionValue Decimal?  @db.Decimal(10, 2)

  // M√©tadonn√©es
  source      String? // Google Ads, R√©seaux sociaux, R√©f√©rence, etc.
  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  @@index([funnelId])
  @@index([leadId])
  @@index([userId])
  @@index([currentStage])
  @@index([isConverted])
  @@index([createdAt])
}

// ============================================================================
// SAVED REPORTS
// ============================================================================

model SavedReport {
  id             String       @id @default(cuid())
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name          String
  metrics       Json // Array of metric IDs
  period        String // 7d, 30d, 90d, 1y, custom
  autoSend      Boolean   @default(false)
  emailSchedule String? // daily, weekly, monthly
  lastSent      DateTime?

  @@index([organizationId])
  @@index([autoSend])
}

// ============================================================================
// ENUMS ADDITIONNELS
// ============================================================================

enum SegmentCriteriaType {
  TOTAL_SPENT
  LAST_VISIT
  VISIT_FREQUENCY
  SERVICE_TYPE
  PRODUCT_PURCHASED
  LOYALTY_POINTS
  REFERRAL_COUNT
  BOOKING_COUNT
  AVERAGE_TICKET
  LIFETIME_VALUE
}

// ============================================================================
// WORKFLOWS & CHURN MANAGEMENT (SUPER-ADMIN)
// ============================================================================

enum WorkflowTrigger {
  ONBOARDING_DAY_1 // J+1 apr√®s inscription
  ONBOARDING_DAY_7 // J+7 apr√®s inscription
  ONBOARDING_DAY_15 // J+15 apr√®s inscription
  ONBOARDING_DAY_25 // J+25 (5 jours avant fin d'essai)
  TRIAL_ENDING_SOON // 5 jours avant fin d'essai
  TRIAL_ENDED // Fin de p√©riode d'essai
  NO_LOGIN_7_DAYS // Pas de connexion depuis 7 jours
  NO_BOOKINGS_15_DAYS // 0 rendez-vous cr√©√© apr√®s 15 jours
  SUBSCRIPTION_ACTIVE_60_DAYS // Apr√®s 60 jours d'utilisation
  PAYMENT_FAILED // √âchec de paiement
  SUBSCRIPTION_CANCELLED // Abonnement annul√©
  HIGH_USAGE // Utilisation √©lev√©e (upgrade sugg√©r√©)
  LOW_USAGE // Faible utilisation (risque churn)
}

enum WorkflowStatus {
  ACTIVE // Workflow actif
  PAUSED // Workflow en pause
  ARCHIVED // Workflow archiv√©
}

// Template de workflow automatique
model WorkflowTemplate {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations
  name        String // "Onboarding J+1", "Relance inactif 7j"
  description String?         @db.Text
  trigger     WorkflowTrigger
  status      WorkflowStatus  @default(ACTIVE)

  // Conditions d'ex√©cution
  delayDays Int @default(0) // D√©lai en jours avant ex√©cution

  // Email settings
  subject       String
  emailTemplate String @db.Text // Template HTML de l'email

  // Statistiques
  sentCount Int   @default(0)
  openRate  Float @default(0)
  clickRate Float @default(0)

  // Relations
  executions WorkflowExecution[]

  @@index([trigger])
  @@index([status])
}

// Ex√©cution d'un workflow pour une organisation
model WorkflowExecution {
  id         String    @id @default(cuid())
  createdAt  DateTime  @default(now())
  executedAt DateTime?

  workflowId String
  workflow   WorkflowTemplate @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Statut
  status String // pending, sent, failed, opened, clicked
  error  String? @db.Text

  // Tracking email
  emailSentAt    DateTime?
  emailOpenedAt  DateTime?
  emailClickedAt DateTime?

  @@index([workflowId])
  @@index([organizationId])
  @@index([status])
}

// M√©triques de churn et r√©tention
model ChurnMetric {
  id   String   @id @default(cuid())
  date DateTime @default(now()) // Date du calcul

  // M√©triques MRR
  totalMRR       Float // MRR total
  newMRR         Float // MRR des nouveaux clients
  expansionMRR   Float // MRR des upgrades
  contractionMRR Float // MRR des downgrades
  churnedMRR     Float // MRR perdu

  // M√©triques clients
  totalCustomers   Int
  newCustomers     Int
  churnedCustomers Int
  activeTrials     Int

  // Taux (en %)
  churnRate     Float // Taux de churn mensuel
  retentionRate Float // Taux de r√©tention

  // LTV moyen
  averageLTV Float // Lifetime Value moyen

  @@index([date])
}

// Clients √† risque de churn
model ChurnRiskProfile {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Score de risque (0-100)
  riskScore Int // 0 = aucun risque, 100 = churn imminent

  // Facteurs de risque
  daysWithoutLogin   Int    @default(0)
  daysWithoutBooking Int    @default(0)
  bookingsCount      Int    @default(0)
  usageLevel         String // low, medium, high

  // Support tickets
  supportTicketsCount Int       @default(0)
  lastSupportDate     DateTime?

  // Actions prises
  contactAttempts Int       @default(0)
  lastContactDate DateTime?

  // Statut
  isAtRisk    Boolean   @default(false)
  churned     Boolean   @default(false)
  churnedAt   DateTime?
  churnReason String?   @db.Text

  @@index([riskScore])
  @@index([isAtRisk])
  @@index([churned])
}

// Raisons d'annulation (post-churn survey)
model CancellationFeedback {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Raison principale
  reason         String // price, features, complexity, competition, other
  detailedReason String? @db.Text

  // Feedback
  wouldRecommend Boolean?
  rating         Int? // 1-5
  suggestions    String?  @db.Text

  // Context
  plan             String
  monthsSubscribed Int

  @@index([organizationId])
  @@index([reason])
}

// ============================================
// SMS MARKETING MODULE (TEAM + PREMIUM)
// ============================================

enum SMSStatus {
  DRAFT // Brouillon
  SCHEDULED // Programm√©
  SENDING // En cours d'envoi
  SENT // Envoy√©
  FAILED // √âchec
}

enum SMSTemplateType {
  BIRTHDAY // Anniversaire
  APPOINTMENT // Rappel RDV
  CONFIRMATION // Confirmation RDV
  PROMOTION // Promotion
  LOYALTY // Fid√©lit√©
  FOLLOW_UP // Suivi apr√®s soin
  CUSTOM // Personnalis√©
}

// Campagnes SMS
model SMSCampaign {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Informations de la campagne
  name    String
  message String @db.Text

  // Destinataires
  segmentId      String? // null = tous les clients
  recipientCount Int     @default(0)

  // Statut
  status SMSStatus @default(DRAFT)

  // Planification
  scheduledAt DateTime?
  sentAt      DateTime?

  // Statistiques
  sentCount      Int @default(0)
  deliveredCount Int @default(0)
  failedCount    Int @default(0)
  clickedCount   Int @default(0) // Si lien dans le SMS

  // Co√ªt
  totalCost Float? // Co√ªt total de la campagne

  // M√©tadonn√©es
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  @@index([organizationId])
  @@index([status])
  @@index([scheduledAt])
  @@index([createdAt])
}

// Templates SMS pr√©-configur√©s
model SMSTemplate {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Informations du template
  name    String
  type    SMSTemplateType
  message String          @db.Text

  // Variables disponibles
  // {{prenom}}, {{nom}}, {{dateRDV}}, {{heureRDV}}, {{service}}, {{institut}}

  // √âtat
  active Boolean @default(true)

  // M√©tadonn√©es
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([type])
  @@index([active])
}

// Historique des SMS envoy√©s (pour tracking individuel)
model SMSLog {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Campagne associ√©e (optionnel)
  campaignId String?

  // Destinataire
  clientId    String?
  clientName  String
  phoneNumber String

  // Contenu
  message String @db.Text

  // Statut
  status       String // sent, delivered, failed, clicked
  errorMessage String? @db.Text

  // Co√ªt
  cost Float?

  // M√©tadonn√©es
  sentAt      DateTime  @default(now())
  deliveredAt DateTime?

  @@index([organizationId])
  @@index([campaignId])
  @@index([clientId])
  @@index([status])
  @@index([sentAt])
}

// ============================================
// REMINDERS & NOTIFICATIONS TRACKING
// ============================================

model SentReminder {
  id           String   @id @default(cuid())
  bookingId    String // ID de la r√©servation
  reminderType String // '24h', '2h', 'post-visit', 'review-email', 'review-whatsapp'
  channel      String // 'email', 'sms', 'whatsapp'
  sentAt       DateTime @default(now())

  @@unique([bookingId, reminderType])
  @@index([bookingId])
  @@index([sentAt])
}

// ============================================
// NEXTAUTH MODELS (OAuth Google, etc.)
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// SYST√àME DE QUOTAS ET USAGE MULTI-TENANT
// ============================================

model OrganizationUsage {
  id             String   @id @default(cuid())
  organizationId String   @unique

  // Usage actuel
  currentUsers       Int @default(0)  // Nombre d'utilisateurs actifs
  currentLocations   Int @default(0)  // Nombre d'√©tablissements
  currentStorageBytes BigInt @default(0) // Stockage utilis√© en bytes

  // Compteurs mensuels (r√©initialis√©s chaque mois)
  emailsSentThisMonth    Int @default(0)
  smsSentThisMonth       Int @default(0)
  whatsappSentThisMonth  Int @default(0)
  apiCallsThisMonth      Int @default(0)

  // Compteurs totaux (jamais r√©initialis√©s)
  totalEmailsSent    Int @default(0)
  totalSmsSent       Int @default(0)
  totalWhatsappSent  Int @default(0)
  totalApiCalls      Int @default(0)
  totalReservations  Int @default(0)
  totalRevenue       Float @default(0) // Chiffre d'affaires total via la plateforme

  // Dates de tracking
  lastResetDate  DateTime @default(now()) // Derni√®re r√©initialisation mensuelle
  lastUpdatedAt  DateTime @updatedAt
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// Historique d'usage mensuel (pour analytics)
model OrganizationUsageHistory {
  id             String   @id @default(cuid())
  organizationId String

  // P√©riode
  year  Int
  month Int

  // Snapshot de fin de mois
  usersCount      Int @default(0)
  locationsCount  Int @default(0)
  storageBytes    BigInt @default(0)
  emailsSent      Int @default(0)
  smsSent         Int @default(0)
  whatsappSent    Int @default(0)
  apiCalls        Int @default(0)
  reservations    Int @default(0)
  revenue         Float @default(0)

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, year, month])
  @@index([organizationId])
}
