generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             String            @id @default(cuid())
  email          String            @unique
  password       String
  name           String
  phone          String?
  role           String            @default("client")
  loyaltyPoints  Int               @default(0)
  totalSpent     Float             @default(0)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  adminNotes     String?
  allergies      String?
  birthDate      DateTime?
  lastVisit      DateTime?
  medicalNotes   String?
  preferences    String?
  skinType       String?
  resetToken     String?
  resetTokenExpiry DateTime?
  evolutions     ClientEvolution[]
  loyaltyHistory LoyaltyHistory[]
  loyaltyProfile LoyaltyProfile?
  reservations   Reservation[]
  reviews        Review[]
  notifications  Notification[]
  referralsMade  Referral[]        @relation("ReferralReferrer")
  referredBy     Referral?         @relation("ReferralReferred")
  leads          Lead[]
  discounts      Discount[]
  orders         Order[]
  payments       Payment[]
  stockMovements StockMovement[]
  giftCards      GiftCard[]        @relation("GiftCardPurchaser")

  // Support tickets
  ticketsCreated SupportTicket[]   @relation("TicketCreator")
  ticketsAssigned SupportTicket[]  @relation("TicketAssignee")
  ticketMessages TicketMessage[]   @relation("TicketMessageAuthor")

  @@index([email])
  @@index([role])
  @@index([createdAt])
}

model Reservation {
  id              String    @id @default(cuid())
  userId          String
  serviceId       String?
  services        String    @default("[]") // JSON array of service IDs
  packages        String    @default("{}") // JSON object with service packages (single/forfait/abonnement)
  isSubscription  Boolean   @default(false) // True si c'est un abonnement mensuel
  date            DateTime
  time            String
  totalPrice      Float
  status          String    @default("pending")
  source          String    @default("site")
  notes           String?
  paymentStatus   String    @default("unpaid")
  paymentDate     DateTime?
  paymentAmount   Float?
  paymentMethod      String?
  stripePaymentId    String?   // ID du paiement Stripe (payment_intent_xxx)
  stripeSessionId    String?   // ID de la session Stripe Checkout
  invoiceNumber      String?
  paymentNotes       String?
  reviewEmailSent    Boolean   @default(false)
  reviewWhatsAppSent Boolean   @default(false)
  reminderSent       Boolean   @default(false)
  reminder24hSent    Boolean   @default(false)
  reminder2hSent     Boolean   @default(false)
  rescheduledFrom    String?   // ID de la r√©servation d'origine si reprogramm√©e
  rescheduledTo      String?   // ID de la nouvelle r√©servation si reprogramm√©e
  rescheduledAt      DateTime? // Date de la reprogrammation
  giftCardId         String?   // ID de la carte cadeau utilis√©e pour cette r√©servation
  giftCardUsedAmount Float?    // Montant de la carte cadeau utilis√©
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id])
  service         Service?  @relation(fields: [serviceId], references: [id])
  giftCard        GiftCard? @relation("GiftCardReservations", fields: [giftCardId], references: [id])
  review          Review?
  stockMovements  StockMovement[]

  @@index([userId])
  @@index([date])
  @@index([status])
  @@index([createdAt])
}

model Service {
  id                String        @id @default(cuid())
  slug              String        @unique @default("")
  name              String
  shortDescription  String        @default("")
  description       String
  metaTitle         String?
  metaDescription   String?
  keywords          String?
  price             Float
  launchPrice       Float?
  promoPrice        Float?
  forfaitPrice      Float?
  forfaitPromo      Float?
  duration          Int
  benefits          String? // JSON
  process           String? // JSON - Deprecated, use protocol instead
  protocol          String? // JSON - Array of {title, duration, desc}
  recommendations   String?
  contraindications String?
  mainImage         String?
  imageSettings     String? // JSON pour objectFit, position, zoom
  imagePositionX    Int?    @default(50) // Position horizontale en %
  imagePositionY    Int?    @default(50) // Position verticale en %
  imageObjectFit    String? @default("cover") // "cover" ou "contain"
  gallery           String? // JSON
  videoUrl          String?
  canBeOption       Boolean       @default(false)
  category          String?       // DEPRECATED: Utiliser categoryId et subcategoryId
  categoryId        String?       // Nouvelle relation vers ServiceCategory
  subcategoryId     String?       // Relation vers ServiceSubcategory
  order             Int           @default(0)
  active            Boolean       @default(true)
  featured          Boolean       @default(false)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  reservations      Reservation[]
  stockLinks        ServiceStock[]  // Relation avec le stock
  serviceCategory   ServiceCategory?    @relation("ServiceToCategory", fields: [categoryId], references: [id])
  serviceSubcategory ServiceSubcategory? @relation("ServiceToSubcategory", fields: [subcategoryId], references: [id])

  @@index([categoryId])
  @@index([subcategoryId])
}

model LoyaltyProfile {
  id                      String    @id @default(cuid())
  userId                  String    @unique
  points                  Int       @default(0)
  tier                    String    @default("BRONZE") // BRONZE, SILVER, GOLD, PLATINUM
  individualServicesCount Int       @default(0)
  packagesCount           Int       @default(0)
  totalSpent              Float     @default(0)
  availableDiscounts      String    @default("[]") // JSON
  referralCode            String?   @unique // Code parrainage unique du client
  referredBy              String?   // Code de parrainage utilis√© lors de l'inscription
  totalReferrals          Int       @default(0) // Nombre de parrainages effectu√©s
  lastVisit               DateTime?
  notes                   String?   @db.Text // Notes administratives sur le client
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  user                    User      @relation(fields: [userId], references: [id])
  history                 LoyaltyHistory[]
}

model LoyaltyHistory {
  id            String         @id @default(cuid())
  userId        String
  profileId     String?
  action        String
  points        Int            @default(0)
  description   String
  reservationId String?
  orderId       String?        // Pour achats produits/formations
  createdAt     DateTime       @default(now())
  user          User           @relation(fields: [userId], references: [id])
  profile       LoyaltyProfile? @relation(fields: [profileId], references: [id])
}

model Referral {
  id                String         @id @default(cuid())
  referrerUserId    String         // ID de l'utilisateur parrain
  referralCode      String         @unique // Code unique de parrainage
  referredEmail     String?        // Email du filleul avant inscription
  referredName      String?        // Nom du filleul
  referredUserId    String?        @unique // ID du filleul une fois inscrit
  status            String         @default("pending") // pending, used, rewarded
  rewardAmount      Float          @default(20) // Montant de la r√©compense en euros
  rewardUsedAt      DateTime?      // Date d'utilisation de la r√©compense
  firstServiceDate  DateTime?      // Date du premier soin du filleul
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  referrer          User           @relation("ReferralReferrer", fields: [referrerUserId], references: [id])
  referred          User?          @relation("ReferralReferred", fields: [referredUserId], references: [id])
}

model BlogPost {
  id              String   @id @default(cuid())
  slug            String   @unique
  title           String
  excerpt         String
  content         String
  category        String
  author          String   @default("LAIA SKIN Institut")
  readTime        String   @default("5 min")
  featured        Boolean  @default(false)
  published       Boolean  @default(true)
  mainImage       String?
  gallery         String? // JSON
  tags            String? // JSON
  metaTitle       String?
  metaDescription String?
  publishedAt     DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model ClientEvolution {
  id             String   @id @default(cuid())
  userId         String
  sessionNumber  Int
  serviceName    String
  sessionDate    DateTime
  beforePhoto    String?
  afterPhoto     String?
  videoUrl       String?
  improvements   String? // JSON
  clientFeedback String?
  adminNotes     String?
  skinAnalysis   String? // JSON
  treatedAreas   String? // JSON
  productsUsed   String? // JSON
  hydrationLevel Int?
  elasticity     Int?
  pigmentation   Int?
  wrinkleDepth   Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id])
}

model Review {
  id            String       @id @default(cuid())
  userId        String
  reservationId String?      @unique
  orderId       String?      @unique // Pour avis sur produits/formations
  serviceName   String?
  itemType      String?      // "service", "product", "formation"
  itemId        String?      // ID du service/produit/formation
  itemName      String?      // Nom du service/produit/formation
  rating        Int
  comment       String
  satisfaction  Int          @default(5)
  photos        String       @default("[]") // JSON array of photo URLs
  response      String?
  approved      Boolean      @default(false)
  featured      Boolean      @default(false)
  source        String       @default("site") // site, email, whatsapp, google
  googleReview  Boolean      @default(false)
  googleUrl     String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  user          User         @relation(fields: [userId], references: [id])
  reservation   Reservation? @relation(fields: [reservationId], references: [id])
  order         Order?       @relation(fields: [orderId], references: [id])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // reminder, promotion, loyalty, birthday, etc.
  title     String
  message   String
  read      Boolean  @default(false)
  actionUrl String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlockedSlot {
  id        String   @id @default(cuid())
  date      DateTime
  time      String?  // Si null, toute la journ√©e est bloqu√©e
  allDay    Boolean  @default(false)
  reason    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([date, time])
}

model WorkingHours {
  id        String   @id @default(cuid())
  dayOfWeek Int      // 0 = Dimanche, 1 = Lundi, etc.
  startTime String   // Format: "14:00"
  endTime   String   // Format: "20:00"
  isOpen    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([dayOfWeek])
}

model Package {
  id          String   @id @default(cuid())
  name        String
  description String
  services    String // JSON array of service IDs
  price       Float
  validDays   Int      @default(90)
  maxUses     Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Lead {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  phone       String?
  subject     String?
  message     String?
  source      String   @default("contact_form") // contact_form, instagram, facebook, phone
  status      String   @default("new") // new, contacted, qualified, converted, lost
  notes       String?
  userId      String?  // Lien vers User si converti en client
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User?    @relation(fields: [userId], references: [id])
}

model SiteConfig {
  id                String   @id @default(cuid())

  // Informations g√©n√©rales
  siteName          String   @default("Laia Skin Institut")
  siteTagline       String?  @default("Institut de Beaut√© & Bien-√™tre")
  siteDescription   String?

  // Contact
  email             String?  @default("contact@laiaskin.com")
  phone             String?  @default("+33 6 XX XX XX XX")
  address           String?
  city              String?
  postalCode        String?

  // R√©seaux sociaux
  facebook          String?
  instagram         String?
  tiktok            String?
  whatsapp          String?

  // Apparence
  primaryColor      String?  @default("#d4b5a0")
  secondaryColor    String?  @default("#2c3e50")
  accentColor       String?  @default("#20b2aa")
  logoUrl           String?
  faviconUrl        String?

  // Typographie
  fontFamily        String?  @default("Inter") // Police principale
  headingFont       String?  @default("Playfair Display") // Police des titres
  baseFontSize      String?  @default("16px") // Taille de base
  headingSize       String?  @default("2.5rem") // Taille des titres

  // Horaires (JSON)
  businessHours     String?  // {"lundi": "9h-18h", "mardi": "9h-18h", ...}

  // Page d'accueil
  heroTitle         String?
  heroSubtitle      String?
  heroImage         String?
  aboutText         String?

  // CGV et mentions l√©gales
  termsAndConditions String?
  privacyPolicy      String?
  legalNotice        String?

  // Emails
  emailSignature     String?
  welcomeEmailText   String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model EmailHistory {
  id           String   @id @default(cuid())
  from         String   @default("contact@laiaskininstitut.fr")
  to           String   // Email ou liste d'emails s√©par√©s par virgule
  subject      String
  content      String   @db.Text // Contenu du message
  template     String?  // Template utilis√©
  status       String   @default("sent") // sent, failed, pending, delivered, received, opened, clicked, bounced
  direction    String   @default("outgoing") // outgoing, incoming
  campaignId   String?
  userId       String?  // Client associ√©
  errorMessage String?
  openedAt     DateTime?
  clickedAt    DateTime?
  openCount    Int      @default(0) // Nombre d'ouvertures
  clickCount   Int      @default(0) // Nombre de clics
  resendId     String?  // ID Resend pour le tracking
  messageId    String?  // Message-ID de l'email
  archived     Boolean  @default(false) // Pour archiver les conversations
  createdAt    DateTime @default(now())
  campaign     EmailCampaign? @relation(fields: [campaignId], references: [id])
}

model EmailCampaign {
  id             String   @id @default(cuid())
  name           String
  subject        String
  content        String
  template       String?
  recipients     String   // JSON array des destinataires
  recipientCount Int      @default(0)
  status         String   @default("draft") // draft, scheduled, sent, cancelled
  scheduledAt    DateTime?
  sentAt         DateTime?
  openRate       Float    @default(0)
  clickRate      Float    @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  emails         EmailHistory[]
}

model Discount {
  id                String    @id @default(cuid())
  userId            String
  type              String    // service_5, package_9, birthday, referral, postponed
  amount            Float
  status            String    @default("available") // available, used, expired, postponed
  originalReason    String    // Raison initiale (ex: "5√®me soin", "9√®me s√©ance", "Anniversaire")
  usedAt            DateTime?
  usedForReservation String?  // ID de la r√©servation o√π la r√©duction a √©t√© utilis√©e
  expiresAt         DateTime? // Date d'expiration
  postponedFrom     String?   // ID de la r√©duction d'origine si report√©e
  postponedTo       DateTime? // Date jusqu'√† laquelle c'est report√©
  postponedReason   String?   // Raison du report
  notes             String?   // Notes additionnelles
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  user              User      @relation(fields: [userId], references: [id])
}

model PromoCode {
  id           String    @id @default(cuid())
  code         String    @unique
  discount     Float     // Montant de la r√©duction
  type         String    // birthday, referral, special
  validFrom    DateTime  @default(now())
  validUntil   DateTime?
  maxUses      Int?      // Nombre max d'utilisations
  usedCount    Int       @default(0)
  userId       String?   // Si le code est sp√©cifique √† un utilisateur
  conditions   String?   // Conditions d'utilisation (JSON)
  active       Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model EmailAutomation {
  id          String   @id @default(cuid())
  name        String
  trigger     String   // birthday, appointment_reminder, review_request, etc.
  template    String   // EmailJS template ID
  enabled     Boolean  @default(true)
  timing      String?  // JSON avec les infos de timing
  conditions  String?  // JSON avec les conditions
  lastRun     DateTime?
  nextRun     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model GoogleReview {
  id           String   @id @default(cuid())
  authorName   String
  authorPhoto  String?
  rating       Int
  comment      String
  reviewId     String   @unique // ID Google pour √©viter les doublons
  publishedAt  DateTime
  replyText    String?
  replyAt      DateTime?
  helpful      Int      @default(0)
  language     String   @default("fr")
  syncedAt     DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model BusinessStats {
  id                 String   @id @default(cuid())
  googleRating       Float    @default(0)
  googleReviewCount  Int      @default(0)
  internalRating     Float    @default(0)
  internalReviewCount Int     @default(0)
  lastGoogleSync     DateTime?
  googlePlaceId      String?
  googleBusinessUrl  String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model NewsletterSubscriber {
  id              String    @id @default(cuid())
  email           String    @unique
  name            String?
  isActive        Boolean   @default(true)
  subscribedAt    DateTime  @default(now())
  unsubscribedAt  DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model WhatsAppHistory {
  id            String   @id @default(cuid())
  from          String   // Num√©ro de t√©l√©phone de l'exp√©diteur
  to            String   // Num√©ro de t√©l√©phone du destinataire
  message       String   // Contenu du message
  status        String   @default("sent") // sent, delivered, read, failed
  direction     String   @default("outgoing") // outgoing, incoming
  userId        String?  // Client associ√©
  mediaUrl      String?  // URL des m√©dias attach√©s
  errorMessage  String?
  deliveredAt   DateTime?
  readAt        DateTime?
  createdAt     DateTime @default(now())
}

model WhatsAppTemplate {
  id            String   @id @default(cuid())
  name          String   @unique
  category      String   // reminder, promotion, birthday, followup, custom
  content       String   // Template avec variables {name}, {time}, etc.
  variables     String   // JSON array des variables utilis√©es
  usage         Int      @default(0)
  successRate   Float    @default(100)
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model WhatsAppAutomation {
  id            String   @id @default(cuid())
  name          String
  trigger       String   // appointment_24h, appointment_48h, birthday, post_service, review_request
  templateId    String   // R√©f√©rence au template
  enabled       Boolean  @default(true)
  timing        String?  // JSON avec les infos de timing (heures avant/apr√®s, heure d'envoi, etc.)
  conditions    String?  // JSON avec les conditions d'envoi
  lastRun       DateTime?
  nextRun       DateTime?
  messagesSent  Int      @default(0)
  successCount  Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model WhatsAppCampaign {
  id             String   @id @default(cuid())
  name           String
  templateId     String   // R√©f√©rence au template
  recipients     String   // JSON array des num√©ros ou tags
  recipientCount Int      @default(0)
  status         String   @default("draft") // draft, scheduled, active, paused, completed, cancelled
  scheduledAt    DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  sentCount      Int      @default(0)
  deliveredCount Int      @default(0)
  readCount      Int      @default(0)
  failedCount    Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model CommunicationHistory {
  id           String   @id @default(cuid())
  userId       String   // Client associ√©
  type         String   // email, whatsapp, sms, call
  direction    String   // incoming, outgoing
  subject      String?  // Pour les emails
  content      String   // Contenu du message
  status       String   @default("sent") // sent, delivered, read, failed
  metadata     String?  // JSON avec m√©tadonn√©es suppl√©mentaires
  createdAt    DateTime @default(now())
}

model Product {
  id               String            @id @default(cuid())
  slug             String            @unique @default("")
  name             String
  description      String
  shortDescription String?
  metaTitle        String?
  metaDescription  String?
  keywords         String?
  price            Float
  salePrice        Float?
  category         String?
  categoryId       String?
  productCategory  ProductCategory?  @relation(fields: [categoryId], references: [id])
  brand            String?
  mainImage        String?
  imageSettings    String?  // JSON pour objectFit, position, zoom
  gallery          String?  // JSON array d'URLs d'images
  ingredients      String?
  usage            String?
  benefits         String?
  active           Boolean  @default(true)
  featured         Boolean  @default(false)
  order            Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model ProductCategory {
  id        String    @id @default(cuid())
  name      String
  slug      String    @unique
  active    Boolean   @default(true)
  order     Int       @default(0)
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Stock {
  id              String    @id @default(cuid())
  name            String
  description     String?
  category        String?   // Consommables, Mat√©riel, Produits de soin, etc.
  quantity        Int       @default(0)
  initialQuantity Int?      // Quantit√© initiale pour afficher "X sur Y"
  minQuantity     Int       @default(5)  // Seuil d'alerte
  unit            String?   // ml, g, pi√®ce, etc.
  cost            Float?    // Prix d'achat
  supplier        String?
  purchaseUrl     String?   // URL pour racheter le produit
  reference       String?
  barcode         String?
  expiryDate      DateTime?
  lastRestocked   DateTime?
  location        String?   // Emplacement dans le stock
  notes           String?
  active          Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  serviceLinks    ServiceStock[]  // Relation avec les services
  movements       StockMovement[]  // Historique des mouvements

  @@index([category])
}

// Table de liaison entre Services et Stock (Many-to-Many)
model ServiceStock {
  id                String    @id @default(cuid())
  serviceId         String
  stockId           String
  quantityPerUse    Float     @default(1)  // Quantit√© consomm√©e par prestation (ex: 5ml, 10g, etc.)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  service           Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  stock             Stock     @relation(fields: [stockId], references: [id], onDelete: Cascade)

  @@unique([serviceId, stockId])
  @@index([serviceId])
  @@index([stockId])
}

// Historique des mouvements de stock
model StockMovement {
  id              String    @id @default(cuid())
  stockId         String
  type            String    // "IN" (ajout), "OUT" (utilisation), "ADJUSTMENT" (ajustement manuel)
  quantity        Float     // Quantit√© (positive ou n√©gative)
  reason          String?   // Raison du mouvement
  reservationId   String?   // Si li√© √† une r√©servation
  userId          String?   // Qui a effectu√© l'action
  createdAt       DateTime  @default(now())

  stock           Stock     @relation(fields: [stockId], references: [id], onDelete: Cascade)
  reservation     Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([stockId])
  @@index([reservationId])
  @@index([createdAt])
}

model Formation {
  id                String   @id @default(cuid())
  slug              String   @unique @default("")
  name              String
  shortDescription  String   @default("")
  description       String
  metaTitle         String?
  metaDescription   String?
  keywords          String?
  price             Float
  promoPrice        Float?
  duration          Int      // Dur√©e en heures
  level             String?  // D√©butant, Interm√©diaire, Avanc√©
  program           String?  // JSON - Programme d√©taill√© de la formation
  objectives        String?  // JSON - Objectifs p√©dagogiques
  prerequisites     String?  // Pr√©requis
  certification     String?  // Type de certification d√©livr√©e
  maxParticipants   Int?     // Nombre max de participants
  mainImage         String?
  imageSettings     String?  // JSON pour objectFit, position, zoom
  gallery           String?  // JSON
  videoUrl          String?
  category          String?
  instructor        String?  // Nom du formateur
  active            Boolean  @default(true)
  featured          Boolean  @default(false)
  order             Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Order {
  id              String   @id @default(cuid())
  orderNumber     String   @unique // Num√©ro de commande unique (ex: ORD-2024-00001)
  userId          String?  // Peut √™tre null pour commandes invit√©s
  customerName    String
  customerEmail   String
  customerPhone   String?
  customerAddress String?  // JSON avec adresse compl√®te

  orderType       String   // "product" ou "formation"
  items           String   // JSON array des articles command√©s [{id, name, quantity, price}]

  subtotal        Float    // Sous-total
  shippingCost    Float    @default(0)
  discount        Float    @default(0)
  totalAmount     Float    // Montant total

  paymentStatus   String   @default("pending") // pending, paid, failed, refunded
  paymentMethod   String?  // card, transfer, cash, stripe
  paymentDate     DateTime?
  transactionId   String?  // ID de transaction Stripe/autre

  status          String   @default("pending") // pending, confirmed, processing, shipped, delivered, cancelled
  shippingStatus  String?  // pending, shipped, delivered
  trackingNumber  String?

  scheduledDate   DateTime? // Date pr√©vue de retrait/livraison/formation
  scheduledTime   String?   // Heure pr√©vue (format HH:mm)

  notes           String?  // Notes client
  adminNotes      String?  // Notes internes admin

  invoiceUrl      String?  // URL de la facture g√©n√©r√©e

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User?    @relation(fields: [userId], references: [id])
  reviews         Review[]

  @@index([userId])
  @@index([orderNumber])
  @@index([paymentStatus])
  @@index([status])
}

model MagicLink {
  id        String   @id @default(cuid())
  token     String   @unique
  email     String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([email])
}

model GiftCard {
  id              String    @id @default(cuid())
  code            String    @unique // Code unique de la carte cadeau (ex: GIFT-XXXX-XXXX)
  amount          Float     // Montant de la carte cadeau
  initialAmount   Float     // Montant initial (pour historique)
  balance         Float     // Solde restant
  purchasedBy     String?   // ID de l'utilisateur qui a achet√©
  purchasedFor    String?   // Nom du b√©n√©ficiaire si cadeau
  recipientEmail  String?   // Email du b√©n√©ficiaire
  recipientPhone  String?   // T√©l√©phone du b√©n√©ficiaire
  message         String?   // Message personnalis√©
  status          String    @default("active") // active, used, expired, cancelled
  purchaseDate    DateTime  @default(now())
  expiryDate      DateTime? // Date d'expiration (optionnelle)
  usedDate        DateTime? // Date d'utilisation compl√®te
  createdBy       String?   // ID admin qui a cr√©√© (si cr√©ation manuelle)
  notes           String?   // Notes admin
  paymentMethod   String?   // Mode de paiement (CB, esp√®ces, ch√®que, etc.)
  paymentStatus   String    @default("paid") // paid, pending
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  purchaser       User?     @relation("GiftCardPurchaser", fields: [purchasedBy], references: [id])
  reservations    Reservation[] @relation("GiftCardReservations") // R√©servations faites avec cette carte

  @@index([code])
  @@index([purchasedBy])
  @@index([status])
}

model GiftCardSettings {
  id                      String   @id @default(cuid())
  emailSubject            String   @default("Vous avez re√ßu une carte cadeau Laia Skin Institut !")
  emailTitle              String   @default("üéÅ Vous avez re√ßu une Carte Cadeau !")
  emailIntro              String   @db.Text @default("Quelle belle attention ! Vous venez de recevoir une carte cadeau pour d√©couvrir ou red√©couvrir les soins d'exception de Laia Skin Institut.")
  emailInstructions       String   @db.Text @default("Utilisez le code ci-dessous lors de votre r√©servation en ligne ou contactez-nous pour prendre rendez-vous.")
  emailFooter             String   @db.Text @default("Cette carte cadeau est valable 1 an √† partir de la date d'√©mission.")
  physicalCardTitle       String   @default("CARTE CADEAU")
  physicalCardSubtitle    String   @default("Laia Skin Institut")
  physicalCardValidity    String   @default("Valable 1 an")
  physicalCardInstructions String  @db.Text @default("Pr√©sentez cette carte lors de votre visite ou utilisez le code en ligne.")
  cardColorFrom           String   @default("#ec4899") // Couleur gradient d√©but (rose par d√©faut)
  cardColorTo             String   @default("#be185d") // Couleur gradient fin (rose fonc√© par d√©faut)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@map("gift_card_settings")
}

model EmailTemplate {
  id        String   @id @default(cuid())
  name      String   // Nom du template (ex: "Promotion du mois")
  subject   String   // Sujet de l'email
  content   String   @db.Text // Contenu de l'email
  category  String?  @default("general") // general, promo, rappel, nouveaute
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("email_templates")
}

model SocialMediaPost {
  id              String    @id @default(cuid())
  userId          String?   // Propri√©taire du post
  socialConfigId  String?   // Compte social media utilis√©
  title           String    // Titre/sujet de la publication
  content         String    @db.Text // Texte de la publication
  platform        String?   // Instagram, Facebook, TikTok, etc.
  scheduledDate   DateTime  // Date de publication pr√©vue
  status          String    @default("draft") // draft, scheduled, published, cancelled
  notes           String?   @db.Text // Notes et id√©es suppl√©mentaires
  links           String?   @db.Text // JSON array de liens utiles
  hashtags        String?   // Hashtags √† utiliser
  mediaUrls       String?   @db.Text // JSON array d'URLs des m√©dias (images/vid√©os)
  publishedAt     DateTime? // Date de publication effective
  apiPostId       String?   // ID de la publication sur la plateforme
  errorMessage    String?   @db.Text // Message d'erreur en cas d'√©chec
  instagramType   String?   // post, story, reel
  facebookType    String?   // post, story, reel
  tiktokType      String?   // reel
  category        String?   // conseils, avant-apres, nouveaute, promotion, etc.
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([scheduledDate])
  @@index([status])
  @@index([category])
}

model SocialMediaConfig {
  id                    String    @id @default(cuid())
  userId                String?   // Propri√©taire du compte (null = compte global)
  platform              String    // instagram, facebook, tiktok, youtube
  accountName           String?   // Nom du compte/page pour affichage
  accessToken           String?   @db.Text // Token d'acc√®s
  refreshToken          String?   @db.Text // Token de rafra√Æchissement
  pageId                String?   // ID de la page/compte
  accountId             String?   // ID du compte Instagram/Facebook
  appId                 String?   // App ID Meta
  appSecret             String?   @db.Text // App Secret Meta
  expiresAt             DateTime? // Date d'expiration du token
  enabled               Boolean   @default(false)
  autoPublish           Boolean   @default(false) // Publication automatique activ√©e
  isDefault             Boolean   @default(false) // Compte par d√©faut pour ce user
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([userId, platform, accountId]) // Un user peut avoir plusieurs comptes par plateforme
  @@index([userId])
  @@index([platform])
}

model WhatsAppConfig {
  id                    String    @id @default(cuid())
  userId                String?   // Propri√©taire du compte (null = compte global)
  accountName           String?   // Nom du compte pour affichage
  phoneNumberId         String?   // ID du num√©ro de t√©l√©phone WhatsApp Business
  phoneNumber           String?   // Num√©ro de t√©l√©phone format√©
  accessToken           String?   @db.Text // Token d'acc√®s WhatsApp Business API
  businessAccountId     String?   // ID du compte WhatsApp Business
  appId                 String?   // App ID Meta
  appSecret             String?   @db.Text // App Secret Meta
  webhookVerifyToken    String?   // Token de v√©rification webhook
  expiresAt             DateTime? // Date d'expiration du token
  enabled               Boolean   @default(false)
  isDefault             Boolean   @default(false) // Compte par d√©faut pour ce user
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([userId, phoneNumberId])
  @@index([userId])
}

model EmailConfig {
  id                    String    @id @default(cuid())
  userId                String?   // Propri√©taire du compte (null = compte global)
  accountName           String?   // Nom du compte pour affichage (ex: "Contact Laia Skin")
  provider              String    // resend, gmail, outlook, etc.
  email                 String    // Adresse email
  apiKey                String?   @db.Text // API Key (pour Resend, SendGrid, etc.)
  password              String?   @db.Text // Mot de passe (pour SMTP)
  smtpHost              String?   // Serveur SMTP
  smtpPort              Int?      // Port SMTP
  imapHost              String?   // Serveur IMAP pour r√©ception
  imapPort              Int?      // Port IMAP
  enabled               Boolean   @default(false)
  isDefault             Boolean   @default(false) // Compte par d√©faut pour ce user
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([userId, email])
  @@index([userId])
}

model Integration {
  id            String   @id @default(cuid())
  userId        String?  // Propri√©taire (null = config globale)
  type          String   // 'stripe', 'google_calendar', 'paypal', 'twilio', etc.
  enabled       Boolean  @default(false)

  // Configuration chiffr√©e (JSON contenant les cl√©s API, tokens, etc.)
  config        Json     @default("{}")

  // Statut de la connexion
  status        String   @default("disconnected") // disconnected, connected, error, expired
  lastSync      DateTime?
  errorMessage  String?  @db.Text

  // M√©tadonn√©es
  displayName   String?  // Nom affich√© dans l'interface
  description   String?  @db.Text

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, type])
  @@index([userId])
  @@index([type])
  @@index([enabled])
}

// Cat√©gories de services (ex: Soins du visage, Soins du corps, √âpilation)
model ServiceCategory {
  id            String   @id @default(cuid())
  name          String   // Ex: "Soins du visage"
  slug          String   @unique // Ex: "soins-visage"
  description   String?  @db.Text
  icon          String?  // Ex: "FaFaceSmile" (nom de l'ic√¥ne React Icons)
  color         String   @default("#e11d48") // Couleur hex pour l'interface
  image         String?  // Image de banni√®re de la cat√©gorie
  order         Int      @default(0) // Ordre d'affichage
  active        Boolean  @default(true)
  featured      Boolean  @default(false) // Mettre en avant sur la page d'accueil

  // SEO
  metaTitle       String?
  metaDescription String?
  keywords        String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  subcategories ServiceSubcategory[]
  services      Service[] @relation("ServiceToCategory")

  @@index([slug])
  @@index([active])
  @@index([order])
}

// Sous-cat√©gories de services (ex: sous "Soins du visage" ‚Üí HydroFacial, BB Glow)
model ServiceSubcategory {
  id          String   @id @default(cuid())
  categoryId  String
  name        String   // Ex: "Soins anti-√¢ge"
  slug        String   @unique // Ex: "soins-anti-age"
  description String?  @db.Text
  icon        String?  // Ic√¥ne sp√©cifique
  image       String?  // Image de la sous-cat√©gorie
  order       Int      @default(0)
  active      Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  category    ServiceCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  services    Service[]       @relation("ServiceToSubcategory")

  @@index([categoryId])
  @@index([slug])
  @@index([active])
  @@index([order])
}

// Historique des paiements (tous types confondus)
model Payment {
  id                  String   @id @default(cuid())
  type                String   // "reservation", "order", "giftcard"
  reservationId       String?
  orderId             String?
  giftCardId          String?
  userId              String
  amount              Float
  currency            String   @default("eur")
  status              String   // "pending", "succeeded", "failed", "refunded"
  paymentMethod       String   // "stripe", "cash", "transfer", "check"

  // Stripe specific
  stripePaymentId     String?  @unique // payment_intent_xxx
  stripeSessionId     String?  // checkout_session_xxx
  stripeCustomerId    String?
  stripeChargeId      String?
  stripeFees          Float?   // Frais Stripe

  // M√©tadonn√©es
  description         String?
  metadata            String?  // JSON pour infos suppl√©mentaires
  receiptUrl          String?  // URL du re√ßu Stripe
  invoiceNumber       String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  user                User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([reservationId])
  @@index([orderId])
  @@index([status])
  @@index([paymentMethod])
  @@index([stripePaymentId])
  @@index([createdAt])
}

// Tickets de support pour le syst√®me de ticketing
model SupportTicket {
  id             String   @id @default(cuid())
  ticketNumber   String   @unique // Ex: TICKET-2024-001
  subject        String
  description    String   @db.Text
  status         String   @default("OPEN") // OPEN, IN_PROGRESS, WAITING_CUSTOMER, RESOLVED, CLOSED
  priority       String   @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  category       String   @default("QUESTION") // TECHNICAL, BILLING, FEATURE_REQUEST, QUESTION, BUG, OTHER

  // Relations
  organizationId String?
  createdById    String
  assignedToId   String?

  // M√©tadonn√©es
  emailSource    String? // Email d'origine si cr√©√© depuis un email
  firstResponseAt DateTime? // Date de premi√®re r√©ponse (SLA)
  resolvedAt     DateTime? // Date de r√©solution
  closedAt       DateTime? // Date de fermeture

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  createdBy      User     @relation("TicketCreator", fields: [createdById], references: [id])
  assignedTo     User?    @relation("TicketAssignee", fields: [assignedToId], references: [id])
  messages       TicketMessage[]

  @@index([ticketNumber])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([createdById])
  @@index([assignedToId])
  @@index([createdAt])
}

// Messages de conversation dans les tickets
model TicketMessage {
  id         String   @id @default(cuid())
  ticketId   String
  authorId   String
  message    String   @db.Text
  isInternal Boolean  @default(false) // True = note interne, False = visible client

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author     User          @relation("TicketMessageAuthor", fields: [authorId], references: [id])

  @@index([ticketId])
  @@index([authorId])
  @@index([createdAt])
}

// Templates d'emails d'onboarding
model OnboardingEmailTemplate {
  id          String   @id @default(cuid())
  name        String   // Nom du template (ex: "Email de bienvenue complet")
  description String   @db.Text // Description du template
  templateKey String   @unique // Cl√© unique (welcome, pending, activation)
  subject     String   // Sujet de l'email avec variables {organizationName}
  content     String   @db.Text // Contenu HTML de l'email
  isActive    Boolean  @default(false) // Seul un template actif par cl√©
  usage       String?  @db.Text // Description de l'usage

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([templateKey])
  @@index([isActive])
  @@map("onboarding_email_templates")
}

