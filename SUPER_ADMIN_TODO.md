# üìã Super Admin - TODO List

## ‚úÖ Fonctionnalit√©s Impl√©ment√©es

### Dashboard & Organisations
- [x] Dashboard principal avec statistiques globales
- [x] Statistiques par plan (SOLO, DUO, TEAM, PREMIUM)
- [x] Statistiques par statut (ACTIVE, TRIAL, SUSPENDED, CANCELLED)
- [x] Liste des organisations avec filtres et recherche
- [x] Export CSV des organisations
- [x] Tri des organisations (nom, date, plan, statut)
- [x] Cr√©ation de nouvelles organisations
- [x] Page de d√©tail d'une organisation
- [x] Modification des organisations (nom, slug, plan, statut, domaine)
- [x] Changement automatique des limites selon le plan

### Emplacements
- [x] Gestion des emplacements (CRUD complet)
- [x] Page d√©di√©e gestion emplacements
- [x] Aper√ßus directs (site, admin, espace client) pour chaque emplacement
- [x] Respect des limites par plan

### Utilisateurs
- [x] Gestion des utilisateurs par organisation
- [x] **Gestion globale de TOUS les utilisateurs (nouvelle page)**
- [x] **Recherche avanc√©e (nom, email, organisation)**
- [x] **Filtres multiples (r√¥le, statut, organisation)**
- [x] **Tri et pagination (50 users par page)**
- [x] **Export CSV de tous les utilisateurs**
- [x] **Statistiques utilisateurs (actifs/inactifs, par r√¥le)**
- [x] Changement de r√¥le utilisateur
- [x] Activation/D√©sactivation utilisateurs
- [x] Suppression d'utilisateurs
- [x] Impersonnation depuis la liste globale

### Param√®tres & Impersonnation
- [x] Param√®tres organisations (g√©n√©ral, paiement, r√©servations, fid√©lit√©)
- [x] Impersonnation (se connecter en tant que propri√©taire)
- [x] Impersonnation d'un utilisateur sp√©cifique
- [x] **Banni√®re d'impersonnation visible en orange en haut de page**
- [x] **Bouton "Retour Super Admin" dans la banni√®re**
- [x] Sortie du mode impersonnation
- [x] **API pour v√©rifier le statut d'impersonnation**

---

## üî¥ PRIORIT√â HAUTE - √Ä Impl√©menter

### ~~1. Gestion Globale des Utilisateurs~~ ‚úÖ TERMIN√â
**Page** : `/super-admin/users` ‚úÖ

**Fonctionnalit√©s impl√©ment√©es** :
- [x] Liste de TOUS les utilisateurs de TOUTES les organisations
- [x] Recherche avanc√©e multi-crit√®res (nom, email, organisation)
- [x] Filtres par r√¥le, statut, organisation
- [x] Tri des colonnes (date, nom, organisation, derni√®re connexion)
- [x] Pagination (50 users par page)
- [x] Actions : activer/d√©sactiver, impersonner
- [x] Export CSV
- [x] Statistiques compl√®tes (total, par r√¥le, actifs/inactifs)

**API Routes cr√©√©es** :
- [x] `GET /api/super-admin/all-users` - Liste tous les users
- [x] `PATCH /api/super-admin/all-users/[userId]` - Modifier user

**Fonctionnalit√©s bonus √† ajouter** :
- [ ] R√©initialiser mot de passe
- [ ] Page de d√©tails utilisateur
- [ ] Historique des actions utilisateur

---

### ~~2. Analytics Dashboard~~ ‚úÖ TERMIN√â
**Page** : `/super-admin/analytics` ‚úÖ

**Fonctionnalit√©s impl√©ment√©es** :
- [x] **Graphiques de croissance** :
  - Nouvelles organisations par mois
  - Nouveaux utilisateurs par mois
  - R√©servations par mois

- [x] **Taux de conversion** :
  - Essai ‚Üí Payant (%)
  - Taux d'annulation (%)
  - Taux de r√©tention (%)

- [x] **Revenus** :
  - MRR (Monthly Recurring Revenue)
  - ARR (Annual Recurring Revenue)
  - Revenus par plan
  - ARPU (Revenu moyen par utilisateur)

- [x] **Comparaisons** :
  - Top 5 organisations (revenus)
  - Top 5 organisations (r√©servations)

- [x] **Filtres** :
  - P√©riode (7j, 30j, 90j, 1an)

**API Routes cr√©√©es** :
- [x] `GET /api/super-admin/analytics` - Toutes les donn√©es analytics

**Fonctionnalit√©s bonus √† ajouter** :
- [ ] Graphiques interactifs avec recharts
- [ ] Export PDF des rapports
- [ ] Comparaisons mois vs mois dernier

---

### ~~3. Syst√®me de Notifications & Alertes~~ ‚úÖ TERMIN√â
**Page** : `/super-admin/notifications` ‚úÖ

**Fonctionnalit√©s impl√©ment√©es** :
- [x] **Types d'alertes d√©finis** :
  - Essais qui expirent dans 7 jours
  - Essais qui expirent dans 3 jours
  - Essais expir√©s
  - Organisations qui atteignent 80% de leurs limites
  - Organisations qui atteignent 100% de leurs limites
  - Paiements √©chou√©s
  - Organisations inactives
  - Nouvelles organisations
  - Abonnements annul√©s

- [x] **Centre de notifications** :
  - Liste des notifications avec stats (total, non lues, lues)
  - Marquer comme lu/non lu (individuel et bulk)
  - Supprimer notifications (individuel et bulk)
  - Filtrer par statut (toutes, non lues, lues)
  - Filtrer par type
  - S√©lection multiple avec actions group√©es
  - Affichage temps relatif (il y a X min/h/j)
  - Couleurs et ic√¥nes par type de notification
  - Lien vers organisation depuis notification

- [x] **Actions rapides depuis les notifications** :
  - Voir l'organisation concern√©e
  - Marquer comme lu/non lu
  - Supprimer

**Tables Prisma cr√©√©es** :
- [x] `SuperAdminNotification` model avec tous les champs
- [x] `NotificationType` enum avec 9 types
- [x] Relations avec Organization

**API Routes cr√©√©es** :
- [x] `GET /api/super-admin/notifications` - Liste notifications avec filtres
- [x] `PATCH /api/super-admin/notifications` - Marquer lu/non lu (bulk)
- [x] `DELETE /api/super-admin/notifications` - Supprimer (bulk)

**T√¢ches Cron √† cr√©er** (TODO) :
- [ ] Script quotidien pour g√©n√©rer les alertes
- [ ] Fichier : `/scripts/check-trials.ts`
- [ ] Fichier : `/scripts/check-limits.ts`

**Fonctionnalit√©s bonus √† ajouter** :
- [ ] Badge avec nombre de notifications non lues dans le header
- [ ] Configuration des alertes (activer/d√©sactiver par type)
- [ ] Email pour les alertes critiques

---

### ~~4. Audit Logs & Historique~~ ‚úÖ TERMIN√â
**Page** : `/super-admin/logs` ‚úÖ

**Fonctionnalit√©s impl√©ment√©es** :
- [x] **Logs des actions super admin** :
  - Qui a fait quoi et quand
  - 17 types d'actions track√©es (CREATE_ORG, UPDATE_ORG, IMPERSONATE, etc.)
  - Informations utilisateur et organisation
  - IP address et User Agent

- [x] **Filtres** :
  - Par action (17 actions disponibles)
  - Par type de cible (ORGANIZATION, USER, LOCATION, SETTINGS)
  - Par date (date d√©but et date fin)
  - Pagination (50 logs par page)

- [x] **Statistiques** :
  - Total logs enregistr√©s
  - Logs aujourd'hui
  - Logs cette semaine
  - Logs ce mois
  - Top 10 actions les plus fr√©quentes

- [x] **D√©tails du log** :
  - Action effectu√©e avec ic√¥ne et couleur
  - Utilisateur qui l'a fait (nom + email)
  - Organisation concern√©e
  - Date et heure format√©e
  - Donn√©es avant/apr√®s (JSON expandable)
  - M√©tadonn√©es (JSON expandable)
  - IP address
  - User Agent

- [x] **Export** :
  - Export des logs en CSV
  - Colonnes: Date, Utilisateur, Action, Type, Organisation, IP, User Agent

**Table Prisma cr√©√©e** :
- [x] `AuditLog` model avec tous les champs
- [x] `AuditAction` enum avec 17 actions
- [x] Relations avec User et Organization
- [x] Index sur userId, action, targetType, organizationId, createdAt

**Lib cr√©√©e** :
- [x] `/lib/audit-logger.ts` - Helper pour cr√©er des logs
- [x] Fonction `createAuditLog()`
- [x] Helpers `getIpAddress()` et `getUserAgent()`

**API Routes cr√©√©es** :
- [x] `GET /api/super-admin/logs` - Liste des logs avec filtres, pagination et stats

**Fonctionnalit√©s bonus √† ajouter** :
- [ ] Int√©grer audit logging dans toutes les routes super admin
- [ ] Alerte si action suspecte d√©tect√©e
- [ ] Graphique timeline des actions
- [ ] Comparaison visuelle avant/apr√®s pour les modifications

---

## üü° PRIORIT√â MOYENNE - √Ä Impl√©menter

### 5. Gestion Facturation & Abonnements
**Page** : `/super-admin/billing`

**Fonctionnalit√©s** :
- [ ] **Int√©gration Stripe Billing** :
  - Connexion compte Stripe
  - Configuration webhooks Stripe
  - Synchronisation abonnements

- [ ] **Historique des paiements** :
  - Liste de tous les paiements
  - Statut (r√©ussi, √©chou√©, en attente)
  - Montant, date, organisation
  - Factures g√©n√©r√©es

- [ ] **Gestion manuelle** :
  - Cr√©er facture manuelle
  - Marquer comme pay√©
  - Rembourser
  - Annuler abonnement

- [ ] **Gestion des essais** :
  - Prolonger p√©riode d'essai
  - R√©duire p√©riode d'essai
  - Convertir en payant imm√©diatement

- [ ] **Configuration des plans** :
  - Modifier prix des plans
  - Modifier limites des plans
  - Cr√©er nouveaux plans
  - Archiver anciens plans

**Tables Prisma √† ajouter** :
```prisma
model Invoice {
  id             String   @id @default(cuid())
  organizationId String
  amount         Float
  currency       String   @default("EUR")
  status         String   // PAID, PENDING, FAILED, REFUNDED
  stripeInvoiceId String?
  paidAt         DateTime?
  dueDate        DateTime
  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])
}

model Payment {
  id             String   @id @default(cuid())
  invoiceId      String
  amount         Float
  method         String   // STRIPE, MANUAL, BANK_TRANSFER
  stripePaymentId String?
  status         String   // SUCCESS, FAILED, REFUNDED
  createdAt      DateTime @default(now())

  invoice        Invoice  @relation(fields: [invoiceId], references: [id])
}
```

**API Routes √† cr√©er** :
- `GET /api/super-admin/billing/invoices` - Liste factures
- `POST /api/super-admin/billing/invoices` - Cr√©er facture
- `POST /api/super-admin/billing/refund/[id]` - Rembourser
- `POST /api/super-admin/billing/extend-trial` - Prolonger essai
- `GET /api/super-admin/billing/plans` - Liste des plans
- `PATCH /api/super-admin/billing/plans/[id]` - Modifier plan

---

### 6. Templates d'Emails
**Page** : `/super-admin/email-templates`

**Fonctionnalit√©s** :
- [ ] **Gestion des templates** :
  - Email de bienvenue nouvelle organisation
  - Email fin d'essai (7j, 3j, expir√©)
  - Email paiement r√©ussi
  - Email paiement √©chou√©
  - Email limite atteinte
  - Email newsletters

- [ ] **√âditeur de template** :
  - √âditeur WYSIWYG
  - Variables dynamiques ({{org_name}}, {{trial_end}}, etc.)
  - Aper√ßu du rendu
  - Test d'envoi

- [ ] **Configuration email** :
  - Param√®tres SMTP
  - Email exp√©diteur
  - Nom exp√©diteur
  - Test connexion SMTP

**Table Prisma** :
```prisma
model EmailTemplate {
  id          String   @id @default(cuid())
  key         String   @unique // WELCOME, TRIAL_ENDING, etc.
  name        String
  subject     String
  htmlBody    String   @db.Text
  textBody    String?  @db.Text
  variables   Json     // Liste des variables disponibles
  active      Boolean  @default(true)
  updatedAt   DateTime @updatedAt
}
```

**API Routes** :
- `GET /api/super-admin/email-templates` - Liste templates
- `GET /api/super-admin/email-templates/[key]` - Get template
- `PATCH /api/super-admin/email-templates/[key]` - Update template
- `POST /api/super-admin/email-templates/test` - Test envoi

---

### 7. Configuration Plateforme
**Page** : `/super-admin/settings`

**Fonctionnalit√©s** :
- [ ] **Param√®tres g√©n√©raux** :
  - Nom de la plateforme
  - Logo
  - Couleurs primaires/secondaires
  - Email de support
  - URL de support

- [ ] **Param√®tres techniques** :
  - Configuration SMTP
  - Cl√©s API (Stripe, etc.)
  - Webhooks URLs
  - Maintenance mode

- [ ] **Limites globales** :
  - Limite organisations
  - Limite utilisateurs par d√©faut
  - Stockage par d√©faut

- [ ] **S√©curit√©** :
  - 2FA obligatoire pour super admins
  - Dur√©e sessions
  - IP whitelist
  - Rate limiting

**Table Prisma** :
```prisma
model PlatformConfig {
  id            String   @id @default(cuid())
  key           String   @unique
  value         Json
  description   String?
  updatedAt     DateTime @updatedAt
  updatedBy     String
}
```

**API Routes** :
- `GET /api/super-admin/settings` - Get all settings
- `PATCH /api/super-admin/settings` - Update settings

---

## üü¢ PRIORIT√â BASSE - Nice to Have

### 8. Syst√®me de Support & Tickets
**Page** : `/super-admin/support`

**Fonctionnalit√©s** :
- [ ] Liste des tickets
- [ ] Cr√©er ticket pour une organisation
- [ ] R√©pondre aux tickets
- [ ] Statuts (ouvert, en cours, r√©solu, ferm√©)
- [ ] Priorit√© (basse, normale, haute, urgente)
- [ ] Attribution √† un super admin
- [ ] Chat en temps r√©el
- [ ] Base de connaissances

---

### 9. Backup & S√©curit√©
**Page** : `/super-admin/backup`

**Fonctionnalit√©s** :
- [ ] Sauvegardes automatiques quotidiennes
- [ ] Liste des sauvegardes
- [ ] T√©l√©charger sauvegarde
- [ ] Restaurer depuis sauvegarde
- [ ] Backup des fichiers (images, documents)
- [ ] Configuration r√©tention (7j, 30j, 90j)

---

### 10. Documentation & API
**Page** : `/super-admin/documentation`

**Fonctionnalit√©s** :
- [ ] Documentation API auto-g√©n√©r√©e
- [ ] Guides d'int√©gration
- [ ] Changelog
- [ ] Webhooks documentation
- [ ] Exemples de code

---

## üì¶ D√©pendances √† Installer

```bash
# Pour les graphiques analytics
npm install recharts
npm install date-fns

# Pour l'√©diteur d'emails
npm install react-email
npm install @react-email/components

# Pour les exports Excel
npm install xlsx

# Pour les graphiques avanc√©s
npm install @tremor/react

# Pour le markdown (documentation)
npm install react-markdown

# Pour les notifications en temps r√©el
npm install pusher-js
npm install pusher
```

---

## üóÇÔ∏è Structure des Fichiers √† Cr√©er

```
src/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ (site)/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ super-admin/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ analytics/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ notifications/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ billing/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ email-templates/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ [key]/
‚îÇ   ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ settings/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ support/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ backup/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îî‚îÄ‚îÄ api/
‚îÇ       ‚îî‚îÄ‚îÄ super-admin/
‚îÇ           ‚îú‚îÄ‚îÄ users/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ route.ts
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ [id]/
‚îÇ           ‚îÇ       ‚îî‚îÄ‚îÄ route.ts
‚îÇ           ‚îú‚îÄ‚îÄ analytics/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ growth/
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ route.ts
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ revenue/
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ route.ts
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ conversion/
‚îÇ           ‚îÇ       ‚îî‚îÄ‚îÄ route.ts
‚îÇ           ‚îú‚îÄ‚îÄ notifications/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ route.ts
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ [id]/
‚îÇ           ‚îÇ       ‚îî‚îÄ‚îÄ route.ts
‚îÇ           ‚îú‚îÄ‚îÄ logs/
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ route.ts
‚îÇ           ‚îú‚îÄ‚îÄ billing/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ invoices/
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ route.ts
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ plans/
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ route.ts
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ extend-trial/
‚îÇ           ‚îÇ       ‚îî‚îÄ‚îÄ route.ts
‚îÇ           ‚îú‚îÄ‚îÄ email-templates/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ route.ts
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ [key]/
‚îÇ           ‚îÇ       ‚îî‚îÄ‚îÄ route.ts
‚îÇ           ‚îî‚îÄ‚îÄ settings/
‚îÇ               ‚îî‚îÄ‚îÄ route.ts
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ analytics/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GrowthChart.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RevenueChart.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ConversionChart.tsx
‚îÇ   ‚îî‚îÄ‚îÄ ImpersonationBanner.tsx (‚úÖ FAIT)
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ audit-logger.ts
‚îÇ   ‚îú‚îÄ‚îÄ email-sender.ts
‚îÇ   ‚îî‚îÄ‚îÄ backup.ts
‚îî‚îÄ‚îÄ scripts/
    ‚îú‚îÄ‚îÄ check-trials.ts
    ‚îú‚îÄ‚îÄ check-limits.ts
    ‚îú‚îÄ‚îÄ send-notifications.ts
    ‚îî‚îÄ‚îÄ backup-database.ts
```

---

## üéØ Ordre de R√©alisation Recommand√©

1. **Semaine 1** : Gestion globale utilisateurs + Audit logs
2. **Semaine 2** : Analytics dashboard + Notifications
3. **Semaine 3** : Billing & Abonnements
4. **Semaine 4** : Email templates + Configuration plateforme
5. **Semaine 5** : Support & Backup (si n√©cessaire)

---

## üìù Notes Importantes

- Toujours logger les actions critiques dans AuditLog
- Tester l'impersonnation avec diff√©rents r√¥les
- S√©curiser toutes les routes API (v√©rifier SUPER_ADMIN)
- Ajouter de la pagination partout (max 100 items par page)
- Impl√©menter le rate limiting pour √©viter les abus
- Pr√©voir des tests unitaires pour les fonctions critiques
- Documenter chaque nouvelle fonctionnalit√©

---

**Date de cr√©ation** : 2025-01-19
**Derni√®re mise √† jour** : 2025-01-19
**Version** : 1.0
