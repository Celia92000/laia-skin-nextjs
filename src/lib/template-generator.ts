import { prisma } from './prisma'

/**
 * Service de g√©n√©ration de template LAIA SKIN INSTITUT
 * G√©n√®re automatiquement un site complet en fonction du plan et des options choisies
 */

interface TemplateGenerationOptions {
  organizationId: string
  organizationName: string
  plan: 'SOLO' | 'DUO' | 'TEAM' | 'PREMIUM'
  ownerFirstName: string
  ownerLastName: string
  primaryColor?: string
  secondaryColor?: string
  // Service initial cr√©√© pendant l'onboarding
  initialService?: {
    name: string
    price: number
    duration: number
    description: string
  }
}

/**
 * G√©n√®re un template complet pour une nouvelle organisation
 */
export async function generateOrganizationTemplate(options: TemplateGenerationOptions) {
  console.log(`üé® G√©n√©ration du template pour: ${options.organizationName} (Plan: ${options.plan})`)

  const { organizationId, organizationName, plan, ownerFirstName, ownerLastName } = options

  // R√©cup√©rer l'organisation et son emplacement principal
  const organization = await prisma.organization.findUnique({
    where: { id: organizationId },
    include: {
      locations: { where: { isMainLocation: true } },
      config: true
    }
  })

  if (!organization || !organization.locations[0]) {
    throw new Error('Organisation ou emplacement principal non trouv√©')
  }

  const mainLocation = organization.locations[0]

  // D√©terminer les features activ√©es selon le plan
  const features = getFeaturesByPlan(plan)

  // 1. Cr√©er les services de base (tous les plans)
  const services = await generateServices(organizationId, mainLocation.id, organizationName, options.initialService)
  console.log(`‚úÖ ${services.length} services cr√©√©s`)

  // 2. Cr√©er les produits (√† partir de TEAM)
  let products = []
  if (features.products) {
    products = await generateProducts(organizationId, organizationName)
    console.log(`‚úÖ ${products.length} produits cr√©√©s`)
  }

  // 3. Cr√©er les formations (PREMIUM uniquement)
  let formations = []
  if (features.formations) {
    formations = await generateFormations(organizationId, organizationName)
    console.log(`‚úÖ ${formations.length} formations cr√©√©es`)
  }

  // 4. Cr√©er les articles de blog (√† partir de DUO)
  let blogPosts = []
  if (features.blog) {
    blogPosts = await generateBlogPosts(organizationId)
    console.log(`‚úÖ ${blogPosts.length} articles de blog cr√©√©s`)
  }

  // 5. Cr√©er les cat√©gories de services
  await generateServiceCategories()
  console.log(`‚úÖ Cat√©gories de services cr√©√©es`)

  // 6. Configurer les param√®tres de r√©servation
  await setupBookingSettings(organizationId)
  console.log(`‚úÖ Param√®tres de r√©servation configur√©s`)

  // 7. Mettre √† jour la configuration de l'organisation
  await updateOrganizationTemplate(organizationId, organizationName, ownerFirstName, ownerLastName, options)
  console.log(`‚úÖ Configuration du site mise √† jour`)

  // 8. Activer les features selon le plan
  await activatePlanFeatures(organizationId, plan)
  console.log(`‚úÖ Features activ√©es pour le plan ${plan}`)

  return {
    services: services.length,
    products: products.length,
    formations: formations.length,
    blogPosts: blogPosts.length,
    features
  }
}

/**
 * D√©termine les features activ√©es selon le plan
 */
function getFeaturesByPlan(plan: string) {
  switch (plan) {
    case 'SOLO':
      return {
        services: true,
        blog: false,
        products: false,
        crm: false,
        stock: false,
        formations: false,
        maxServices: 10,
        maxProducts: 0,
        maxBlogPosts: 0
      }
    case 'DUO':
      return {
        services: true,
        blog: true,
        products: false,
        crm: false,
        stock: false,
        formations: false,
        maxServices: 20,
        maxProducts: 0,
        maxBlogPosts: 10
      }
    case 'TEAM':
      return {
        services: true,
        blog: true,
        products: true,
        crm: true,
        stock: false,
        formations: false,
        maxServices: 50,
        maxProducts: 30,
        maxBlogPosts: 30
      }
    case 'PREMIUM':
      return {
        services: true,
        blog: true,
        products: true,
        crm: true,
        stock: true,
        formations: true,
        maxServices: -1, // Illimit√©
        maxProducts: -1,
        maxBlogPosts: -1
      }
    default:
      return getFeaturesByPlan('SOLO')
  }
}

/**
 * G√©n√®re les services de d√©monstration
 */
async function generateServices(
  orgId: string,
  locationId: string,
  orgName: string,
  initialService?: any
) {
  const servicesData = [
    // Si un service initial a √©t√© cr√©√©, on le r√©cup√®re
    ...(initialService ? [] : [{
      name: 'Soin du Visage Signature',
      slug: 'soin-visage-signature',
      description: 'Notre soin phare pour une peau √©clatante',
      shortDescription: 'Soin complet du visage',
      price: 75,
      duration: 60,
      featured: true,
      active: true
    }]),
    {
      name: 'Massage Relaxant',
      slug: 'massage-relaxant',
      description: 'Massage complet pour √©vacuer le stress et les tensions',
      shortDescription: 'Massage relaxant corps entier',
      price: 85,
      duration: 60,
      featured: true,
      active: true
    },
    {
      name: '√âpilation Sourcils',
      slug: 'epilation-sourcils',
      description: '√âpilation pr√©cise pour sublimer votre regard',
      shortDescription: '√âpilation et restructuration des sourcils',
      price: 15,
      duration: 15,
      featured: false,
      active: true
    },
    {
      name: 'Manucure Compl√®te',
      slug: 'manucure-complete',
      description: 'Soin complet des mains avec pose de vernis',
      shortDescription: 'Manucure avec vernis',
      price: 35,
      duration: 45,
      featured: false,
      active: true
    },
    {
      name: 'P√©dicure Spa',
      slug: 'pedicure-spa',
      description: 'Soin complet des pieds avec bain relaxant',
      shortDescription: 'P√©dicure avec massage',
      price: 45,
      duration: 60,
      featured: false,
      active: true
    }
  ]

  const services = []
  for (const serviceData of servicesData) {
    const service = await prisma.service.create({
      data: {
        ...serviceData,
        organizationId: orgId
      }
    })
    services.push(service)
  }

  return services
}

/**
 * G√©n√®re les produits de d√©monstration (TEAM+)
 */
async function generateProducts(orgId: string, orgName: string) {
  const productsData = [
    {
      name: 'Cr√®me Hydratante Visage',
      slug: 'creme-hydratante-visage',
      description: 'Cr√®me hydratante enrichie en acide hyaluronique pour une hydratation 24h. Convient √† tous les types de peaux.',
      shortDescription: 'Hydratation intense 24h',
      price: 45,
      category: 'Soins Visage',
      featured: true,
      active: true
    },
    {
      name: 'S√©rum Anti-√Çge',
      slug: 'serum-anti-age',
      description: 'S√©rum concentr√© aux peptides et antioxydants pour r√©duire les rides et raffermir la peau.',
      shortDescription: 'Concentr√© de jeunesse',
      price: 65,
      category: 'Soins Visage',
      featured: true,
      active: true
    },
    {
      name: 'Huile de Massage',
      slug: 'huile-massage',
      description: 'Huile de massage aux huiles essentielles apaisantes pour prolonger le bien-√™tre.',
      shortDescription: 'Huile relaxante',
      price: 30,
      category: 'Bien-√™tre',
      featured: false,
      active: true
    }
  ]

  const products = []
  for (const productData of productsData) {
    const product = await prisma.product.create({
      data: {
        ...productData,
        organizationId: orgId
      }
    })
    products.push(product)
  }

  return products
}

/**
 * G√©n√®re les formations de d√©monstration (PREMIUM)
 */
async function generateFormations(orgId: string, orgName: string) {
  const formationsData = [
    {
      name: 'Initiation au Massage Relaxant',
      slug: 'initiation-massage-relaxant',
      description: 'Formation compl√®te pour ma√Ætriser les bases du massage relaxant. Parfait pour les d√©butants.',
      shortDescription: 'Apprenez les techniques de massage',
      price: 450,
      duration: 2, // 2 jours
      level: 'D√©butant',
      active: true,
      featured: true,
      organizationId: orgId
    },
    {
      name: 'Perfectionnement Soins du Visage',
      slug: 'perfectionnement-soins-visage',
      description: 'Techniques avanc√©es pour les professionnels souhaitant se perfectionner dans les soins du visage.',
      shortDescription: 'Techniques avanc√©es',
      price: 350,
      duration: 1, // 1 jour
      level: 'Interm√©diaire',
      active: true,
      featured: false,
      organizationId: orgId
    }
  ]

  const formations = []
  for (const formationData of formationsData) {
    const formation = await prisma.formation.create({
      data: formationData
    })
    formations.push(formation)
  }

  return formations
}

/**
 * G√©n√®re les articles de blog (DUO+)
 */
async function generateBlogPosts(orgId: string) {
  const blogPostsData = [
    {
      title: '5 Conseils pour une Peau √âclatante',
      slug: '5-conseils-peau-eclatante',
      excerpt: 'D√©couvrez nos meilleurs conseils pour avoir une peau radieuse au quotidien',
      content: `# 5 Conseils pour une Peau √âclatante

Une peau √©clatante est le reflet d'une bonne sant√©. Voici nos 5 conseils d'expertes :

## 1. Hydratation
Buvez au moins 1,5L d'eau par jour et utilisez une cr√®me hydratante adapt√©e.

## 2. Nettoyage
Nettoyez votre visage matin et soir avec un produit doux.

## 3. Protection solaire
Appliquez une cr√®me solaire tous les jours, m√™me en hiver.

## 4. Alimentation √©quilibr√©e
Privil√©giez les fruits et l√©gumes riches en antioxydants.

## 5. Sommeil r√©parateur
Dormez 7 √† 8 heures par nuit pour permettre √† votre peau de se r√©g√©n√©rer.`,
      category: 'Conseils Beaut√©',
      author: '√âquipe LAIA',
      readTime: '3 min',
      featured: true,
      published: true,
      organizationId: orgId
    },
    {
      title: 'Les Bienfaits du Massage',
      slug: 'bienfaits-massage',
      excerpt: 'Le massage n\'est pas qu\'un moment de d√©tente, d√©couvrez tous ses bienfaits',
      content: `# Les Bienfaits du Massage

Le massage est bien plus qu'un simple moment de relaxation :

## R√©duction du stress
Le massage favorise la production d'endorphines, les hormones du bien-√™tre.

## Soulagement des douleurs
Les techniques de massage aident √† d√©tendre les muscles et soulager les tensions.

## Am√©lioration de la circulation
Le massage stimule la circulation sanguine et lymphatique.

## Meilleur sommeil
Un massage r√©gulier am√©liore la qualit√© du sommeil.`,
      category: 'Bien-√™tre',
      author: '√âquipe LAIA',
      readTime: '4 min',
      featured: false,
      published: true,
      organizationId: orgId
    }
  ]

  const blogPosts = []
  for (const blogData of blogPostsData) {
    const post = await prisma.blogPost.create({
      data: blogData
    })
    blogPosts.push(post)
  }

  return blogPosts
}

/**
 * Cr√©e les cat√©gories de services
 */
async function generateServiceCategories() {
  const categories = [
    { name: 'Soins du Visage', slug: 'soins-visage', icon: 'FaFaceSmile', color: '#e11d48' },
    { name: 'Soins du Corps', slug: 'soins-corps', icon: 'FaSpa', color: '#7c3aed' },
    { name: '√âpilation', slug: 'epilation', icon: 'FaFeather', color: '#0891b2' },
    { name: 'Manucure & P√©dicure', slug: 'manucure-pedicure', icon: 'FaHandSparkles', color: '#dc2626' },
    { name: 'Massages', slug: 'massages', icon: 'FaHandHoldingHeart', color: '#16a34a' }
  ]

  for (const cat of categories) {
    await prisma.serviceCategory.upsert({
      where: { slug: cat.slug },
      update: {},
      create: cat
    })
  }
}

/**
 * Configure les param√®tres de r√©servation
 */
async function setupBookingSettings(orgId: string) {
  await prisma.bookingSettings.create({
    data: {
      organizationId: orgId,
      minAdvanceBookingHours: 2,
      maxAdvanceBookingDays: 30,
      cancellationDeadlineHours: 24,
      allowStaffSelection: true,
      requireLocationSelection: false,
      allowOnlinePayment: true,
      sendConfirmationEmail: true,
      sendReminder24h: true,
      sendReminder2h: false,
      sendReviewRequest: true
    }
  })
}

/**
 * Met √† jour la configuration du site avec le template
 */
async function updateOrganizationTemplate(
  orgId: string,
  orgName: string,
  ownerFirstName: string,
  ownerLastName: string,
  options: TemplateGenerationOptions
) {
  const fullName = `${ownerFirstName} ${ownerLastName}`

  await prisma.organizationConfig.upsert({
    where: { organizationId: orgId },
    update: {
      siteTagline: 'Institut de Beaut√© & Bien-√™tre',
      siteDescription: `Bienvenue chez ${orgName}, votre institut de beaut√© d√©di√© √† votre bien-√™tre et votre beaut√© naturelle.`,
      heroTitle: `Bienvenue chez ${orgName}`,
      heroSubtitle: 'Votre beaut√©, notre passion',
      aboutText: `${orgName} est un institut de beaut√© moderne qui allie savoir-faire traditionnel et techniques innovantes pour vous offrir des soins d'exception.`,
      founderName: fullName,
      founderTitle: 'Fondateur/Fondatrice',
      founderQuote: 'La beaut√© commence par prendre soin de soi',
      aboutIntro: `Depuis sa cr√©ation, ${orgName} s'engage √† offrir des soins de qualit√© dans une atmosph√®re chaleureuse et relaxante.`,
      aboutParcours: 'Notre √©quipe de professionnelles qualifi√©es met son expertise √† votre service pour des r√©sultats visibles et durables.',
      primaryColor: options.primaryColor || '#d4b5a0',
      secondaryColor: options.secondaryColor || '#2c3e50',
      accentColor: '#20b2aa',
      fontFamily: 'Inter',
      headingFont: 'Playfair Display',
      legalRepName: fullName,
      legalRepTitle: 'G√©rant(e)'
    },
    create: {
      organizationId: orgId,
      siteName: orgName,
      siteTagline: 'Institut de Beaut√© & Bien-√™tre',
      siteDescription: `Bienvenue chez ${orgName}, votre institut de beaut√© d√©di√© √† votre bien-√™tre et votre beaut√© naturelle.`,
      heroTitle: `Bienvenue chez ${orgName}`,
      heroSubtitle: 'Votre beaut√©, notre passion',
      aboutText: `${orgName} est un institut de beaut√© moderne qui allie savoir-faire traditionnel et techniques innovantes pour vous offrir des soins d'exception.`,
      founderName: fullName,
      founderTitle: 'Fondateur/Fondatrice',
      founderQuote: 'La beaut√© commence par prendre soin de soi',
      aboutIntro: `Depuis sa cr√©ation, ${orgName} s'engage √† offrir des soins de qualit√© dans une atmosph√®re chaleureuse et relaxante.`,
      aboutParcours: 'Notre √©quipe de professionnelles qualifi√©es met son expertise √† votre service pour des r√©sultats visibles et durables.',
      primaryColor: options.primaryColor || '#d4b5a0',
      secondaryColor: options.secondaryColor || '#2c3e50',
      accentColor: '#20b2aa',
      fontFamily: 'Inter',
      headingFont: 'Playfair Display',
      legalRepName: fullName,
      legalRepTitle: 'G√©rant(e)'
    }
  })
}

/**
 * Active les features selon le plan choisi
 */
async function activatePlanFeatures(orgId: string, plan: string) {
  const features = getFeaturesByPlan(plan)

  await prisma.organization.update({
    where: { id: orgId },
    data: {
      featureBlog: features.blog,
      featureProducts: features.products,
      featureCRM: features.crm,
      featureStock: features.stock,
      featureFormations: features.formations
    }
  })
}
